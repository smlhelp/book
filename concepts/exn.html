<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Exceptions - SML Help</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A resource for learning SML">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Welcome!</a></li><li class="chapter-item expanded "><a href="../start/index.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../start/install.html"><strong aria-hidden="true">1.1.</strong> Install &amp; run SML</a></li><li class="chapter-item expanded "><a href="../start/syntax.html"><strong aria-hidden="true">1.2.</strong> Syntax Cheatsheet</a></li><li class="chapter-item expanded "><a href="../start/common.html"><strong aria-hidden="true">1.3.</strong> Common Tasks</a></li></ol></li><li class="chapter-item expanded "><a href="../types/index.html"><strong aria-hidden="true">2.</strong> Types &amp; Signatures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../types/type.html"><strong aria-hidden="true">2.1.</strong> Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../types/bool.html"><strong aria-hidden="true">2.1.1.</strong> bool</a></li><li class="chapter-item expanded "><a href="../types/int.html"><strong aria-hidden="true">2.1.2.</strong> int</a></li><li class="chapter-item expanded "><a href="../types/real.html"><strong aria-hidden="true">2.1.3.</strong> real</a></li><li class="chapter-item expanded "><a href="../types/string.html"><strong aria-hidden="true">2.1.4.</strong> string</a></li><li class="chapter-item expanded "><a href="../types/function.html"><strong aria-hidden="true">2.1.5.</strong> function types</a></li><li class="chapter-item expanded "><a href="../types/list.html"><strong aria-hidden="true">2.1.6.</strong> list</a></li><li class="chapter-item expanded "><a href="../types/options.html"><strong aria-hidden="true">2.1.7.</strong> options</a></li></ol></li><li class="chapter-item expanded "><a href="../types/sig.html"><strong aria-hidden="true">2.2.</strong> Signatures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../types/dict.html"><strong aria-hidden="true">2.2.1.</strong> dictionaries</a></li><li class="chapter-item expanded "><a href="../types/regex.html"><strong aria-hidden="true">2.2.2.</strong> regular expressions</a></li><li class="chapter-item expanded "><a href="../seq/seq.html"><strong aria-hidden="true">2.2.3.</strong> sequences</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../debugging/index.html"><strong aria-hidden="true">3.</strong> Debugging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../debugging/errors.html"><strong aria-hidden="true">3.1.</strong> Common Errors</a></li><li class="chapter-item expanded "><a href="../debugging/hints.html"><strong aria-hidden="true">3.2.</strong> Debugging Hints</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/index.html"><strong aria-hidden="true">4.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/basic.html"><strong aria-hidden="true">4.1.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/eval.html"><strong aria-hidden="true">4.1.1.</strong> Evaluation</a></li><li class="chapter-item expanded "><a href="../concepts/eeq.html"><strong aria-hidden="true">4.1.2.</strong> Extensional Equivalence</a></li><li class="chapter-item expanded "><a href="../concepts/patternmatch.html"><strong aria-hidden="true">4.1.3.</strong> Pattern Matching</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/recind.html"><strong aria-hidden="true">4.2.</strong> Recursion and Induction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/induct.html"><strong aria-hidden="true">4.2.1.</strong> Inductive Proofs</a></li><li class="chapter-item expanded "><a href="../concepts/rec.html"><strong aria-hidden="true">4.2.2.</strong> Recursion</a></li><li class="chapter-item expanded "><a href="../concepts/tail.html"><strong aria-hidden="true">4.2.3.</strong> Tail Recursion</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/analysis.html"><strong aria-hidden="true">4.3.</strong> Asymptotic Analysis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/workspan.html"><strong aria-hidden="true">4.3.1.</strong> Work and Span</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/datatypes.html"><strong aria-hidden="true">4.4.</strong> Datatypes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/poly.html"><strong aria-hidden="true">4.4.1.</strong> Parametric Polymorphism</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/hofs.html"><strong aria-hidden="true">4.5.</strong> Higher Order Functions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/curry.html"><strong aria-hidden="true">4.5.1.</strong> Currying and Staging</a></li><li class="chapter-item expanded "><a href="../concepts/common.html"><strong aria-hidden="true">4.5.2.</strong> Common HOFs and Partial Evaluation</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/control.html"><strong aria-hidden="true">4.6.</strong> Control Flow</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/cps.html"><strong aria-hidden="true">4.6.1.</strong> Continuation Passing Style</a></li><li class="chapter-item expanded "><a href="../concepts/exn.html" class="active"><strong aria-hidden="true">4.6.2.</strong> Exceptions</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/mods.html"><strong aria-hidden="true">4.7.</strong> Modules</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/mods.html"><strong aria-hidden="true">4.7.1.</strong> Basics and Ascription</a></li><li class="chapter-item expanded "><a href="../concepts/functors.html"><strong aria-hidden="true">4.7.2.</strong> Functors</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/apps.html"><strong aria-hidden="true">4.8.</strong> Applications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/sequences.html"><strong aria-hidden="true">4.8.1.</strong> Sequences</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">5.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/basics.html"><strong aria-hidden="true">5.1.</strong> Basics</a></li><li class="chapter-item expanded "><a href="../examples/recursion.html"><strong aria-hidden="true">5.2.</strong> Recursion &amp; Induction</a></li></ol></li><li class="chapter-item expanded "><a href="../about.html">About</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">SML Help</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="exceptions"><a class="header" href="#exceptions">Exceptions</a></h1>
<p><em>By Brandon Wu, June 2020</em></p>
<p>So far, we have seen how we can manipulate the constructs of SML to create
unique control flow behavior in the form of continuation passing style. In this
section, we will discuss <em>exceptions</em>, which are themselves a builtin feature of
the language. With exceptions, we can cover cases where continuing to evaluate an
exprerssion does not make sense or is ill-defined at run-time.</p>
<h2 id="built-in-exceptions"><a class="header" href="#built-in-exceptions">Built-In Exceptions</a></h2>
<p>We have seen how SML interprets computation as evaluation, and how we can reduce
our entire notion of program execution to application of simple reduction rules.
Sometimes, however, we run into cases where attempting to apply some rule
results in an error, or in some output that we cannot actually
express. In such cases, it is necessary to actually <em>halt</em> evaluation with some
manner of effect - this is the behavior that exceptions will introduce.</p>
<p>While we would like to be able to push as many of these errors as possible to compile 
time, it is not always the case that this is possible - this is usually when
dealing with cases where computation is made infeasible by the <em>values</em>
that are bound to identifiers, which cannot be determined <em>a priori</em> at compile
time. As such, we have no way of telling beforehand if such errors will occur -
forcing us to define some notion of a <em>run-time error</em>.</p>
<p>You have likely already encountered exceptions - the canonical example is of <code>1 div 0</code>, which, when entered in the REPL, will result in an <code>uncaught exception Div</code>. This is because we cannot sensically evaluate <code>1 div 0</code> to some value -
what integer could we possibly return? The other option, then, is to simply
quit, and not even try to evaluate further. This is why division by zero results
in an exception.</p>
<p>Another example is of the declaration <code>val x::xs = []</code>. This signifies an
attempt at pattern matching, where we attempt to pattern match <code>x::xs</code> to <code>[]</code>.
Plainly, however, we cannot possibly carry this out - what values could we bind
to <code>x</code> and <code>xs</code> to make this valid? Thus, we will also need to have some
exception for an incorrect binding - which is appropriately named as the <code>Bind</code>
exception.</p>
<p>Finally, in general we are interested in writing functions that are
<em>exhaustive</em>, in that they are defined on all values of their input type. Even
if a function is only <em>meant</em> to be called on values within a certain domain, it
is often a good idea to be safe and cover all of the cases anyways. We call such
a function that is not defined on certain inputs <em>nonexhaustive</em>, and defining
them will generally result in a non-exhaustive match warning, though it will
still be permitted.</p>
<p>Consider the function <code>fn true =&gt; 1</code>, which is plainly nonexhaustive, not
covering the <code>false</code> case. Nonetheless, it is a function of type <code>bool -&gt; int</code>
that can be bound to an identifier. How, then, should we handle the case of
attempting to evaluate <code>(fn true =&gt; 1) false</code>? This is a well-typed expression,
causing it to fly under the radar of our compile-time tests. At run-time, then,
we cannot evaluate this expression through function application - the function
does not specify what it should return in this case! As such, we will simply
raise a <code>Match</code> exception, signifying that the function's input was not able to
match to any particular clause of the function. Note how this differs from
<code>Bind</code>, which occurs as a result of attempting to produce a binding, not when
attempting to apply a function.</p>
<h2 id="defining-exceptions-basic"><a class="header" href="#defining-exceptions-basic">Defining Exceptions: Basic</a></h2>
<p>We have now seen the built-in exceptions that are automatically raised for
certain prescribed use cases. Oftentimes, however, we are interested in our own
specified use cases, meaning that we likely do not want to use the exceptions
<code>Div</code>, <code>Match</code>, and <code>Bind</code>, which may be unrelated. In this case, we want to
define our own exceptions.</p>
<p>The syntax for defining exceptions is as follows:</p>
<pre><code class="language-sml">exception Error
</code></pre>
<p>This introduces the constructor named Error, which corresponds to the
identically named exception Error. Exception constructors are <em>first class</em>,
meaning that they are themselves values. The type of exception constructors is
<code>exn</code>, so this line really introduces the value <code>Error : exn</code>. The type <code>exn</code>
stands for &quot;exception name&quot;, but it is also useful to think of it as standing
for &quot;extensible&quot;, since the type <code>exn</code> is <em>extensible</em>. This means that we
can <em>extend</em> the values that populate <code>exn</code> with new constructors, like we did 
with <code>Error</code>.</p>
<p>The value <code>Error</code> is not, by itself, an exception, however we can use it to
raise exceptions with the <code>raise</code> keyword. We can think of the <code>raise</code> keyword
as being &quot;like&quot; a function of type <code>exn -&gt; 'a</code>, in that it &quot;takes in&quot; a value of
type <code>exn</code> and has type <code>'a</code>. It is important to remember that <code>raise</code> is <em>not</em>
a function really, though - it merely has similar behavior when used to raise
exceptions, but it is not first class.</p>
<p>The polymorphic &quot;return type&quot; of the <code>raise</code> keyword is so that raising
exceptions can be compatible with our type system. Suppose we want to write a
factorial function that, instead of looping forever on negative inputs, raises
an exception.</p>
<pre><code class="language-sml">exception Negative

fun fact' 0 = 1
  | fact' n = 
      if n &lt; 0 then raise Negative
               else n * fact' (n-1)
</code></pre>
<p>This code fragment should carry out our desired behavior. Consider the type of
<code>raise Negative</code> - we would like to raise an exception, but we know that the
expressions in both branches of an if then else expression must be the same
type. In the positive case, this has type <code>int</code>, corresponding to just
calculating the actual factorial. Therefore the negative case must also be
<code>int</code>, though we also want to raise an exception. To be compatible with this, 
<code>raise Negative</code> must have type <code>int</code>.</p>
<p>We would not like <code>raise Negative</code> to have type <code>int</code> in <em>general</em>, however -
this depends on our use case! We want raising exceptions to be able to just
<em>work</em>, type-wise, since we know that it never returns a well-defined value anyways. 
As such, we define raising exceptions to have a <em>polymorphic</em> return type, so that
it fits within our type system correctly, no matter the use case. This is also
the reason why we can write <code>raise Fail &quot;Unimplemented&quot;</code> as the output of
not-yet defined functions and still pass typechecking, no matter how complicated
the function.</p>
<h2 id="exceptional-control-flow"><a class="header" href="#exceptional-control-flow">Exceptional Control Flow</a></h2>
<p>At this point, we have seen how exceptions let us implement a very limited form
of &quot;control flow&quot;, in that we can stop the flow of control entirely - upon
encountering a raised exception, computation ceases. This is rather rudimentary
in terms of expressiveness - we can only create programs that forcibly
terminate! In this section, however, we will explore the usage of <code>handle</code>, a
keyword that allows us to have more sophisticated behavior with respect to
programs deal with raised exceptions.</p>
<blockquote>
<p><strong>[handle]</strong> For expressions <code>e : t</code>, <code>e1 : t</code> ... <code>en : t</code>, and different values 
<code>Exn1 : exn</code> ... <code>ExnN : exn</code>, if the expression <code>e</code> raises the exception
<code>ExnI</code>, then the expression </p>
<pre><code>e handle Exn2 =&gt; e1
       | Exn2 =&gt; e3
       ...
       | ExnN =&gt; en
</code></pre>
<p>reduces to <code>eI</code>.</p>
<p>In other words, the <code>handle</code> keyword lets us case on the exception raised by
an expression.</p>
</blockquote>
<p>It is important to note that all the expressions <code>e</code>, <code>e1</code>, ... <code>en</code> have to be
of the same type. Consider what would happen if they were not:</p>
<pre><code class="language-sml">e handle Div =&gt; &quot;Oh no!&quot;
</code></pre>
<p>Let <code>e</code> be an expression of type <code>int</code>. Suppose that, in this case, <code>e</code> raises <code>Div</code>, 
so ostensibly this expression should reduce to <code>&quot;Oh no!&quot;</code>. However, what would happen 
if <code>Div</code> was not raised? Then, we would have <code>e</code>, which is of type <code>int</code>.</p>
<p>We've violated type safety here. We cannot &quot;sometimes&quot; have an expression be one
type and another time have it be another. We must have <em>static type guarantees</em>.
As such, all the arms of a <code>handle</code> must agree, and additionally they must agree
with the type of the expression being handled.</p>
<p>We say that an exception that is raised can either propagate up to the <em>top
level</em> (in which case the program or expression simply results in an uncaught
exception), or to the <em>nearest handler</em>. To clarify the meaning of &quot;nearest&quot;,
take the evaluation of the expression <code>(1 + (1 div 0)) * 3 handle Div =&gt; 5</code>, for
example. We see that <code>1 div 0</code> raises the exception <code>Div</code>, so the inner
expression is extensionally equivalent to <code>(1 + raise Div) * 3</code>. Then, applying
this logic one more time, <code>1 + raise Div</code> clearly should also raise <code>Div</code>, so we
get that it is extensionally equivalent to <code>raise Div * 3</code>, which is then
extensionally equivalent to <code>raise Div</code>. What we see is that this raised
exception &quot;propagates up&quot; as it subsumes more and more expressions, until
eventually it reaches a handler.</p>
<p>While we now see how we can handle different kinds of exceptions, we might want
to make a more educated choice about what our next action should be. It might be
the case that we raise an exception in some failed branch of the program, but we
want to have more information about exactly what happened, or what the program
was doing at the time. We will now discuss <em>information-carrying exceptions</em>,
which are nothing other than an extension of our declarations of exceptions to
being more akin to how we declare datatypes.</p>
<p>In a similar vein to how we can declare <code>datatype Foo = Bar of int</code> to denote
that a value of type <code>Foo</code> is the constructor <code>Bar</code> wrapping a value of type
<code>int</code>, we can declare values of type <code>exn</code> to also be constructors wrapping
values. This takes the form:</p>
<pre><code class="language-sml">exception Crash of int
</code></pre>
<p>which denotes that <code>Crash 1</code> and <code>Crash 5</code>, among others, are values of type
<code>exn</code>, and can thus be <code>raise</code>d. Note that <code>Crash</code> thus has type <code>int -&gt; exn</code>.</p>
<p>Concretely, we can &quot;pattern match&quot; on the data contained by the exception
handler by doing something like the following:</p>
<pre><code class="language-sml">exception Return of int

fun factException 0 = raise Return 1
  | factException n = factException (n - 1) handle (Return res) =&gt; raise Return
  (n - 1)
</code></pre>
<p><strong>NOTE:</strong> It is not clear why anyone would want to define <code>fact</code> this way.</p>
<p>This example makes use of an exception, <code>Return : int -&gt; exn</code>, which wraps the
return value of <code>fact</code>. <code>fact</code>, at each step, simply raises an exception
containing its return value, which (in a future recursive call) is handled, the
value unwrapped (bound to <code>res</code>), then multiplied by the current value of <code>n</code> to
generate the next value, which is simply raised again. This is very similar to a
<code>case</code> expression - we simply pattern match on the raised exception's constructor 
using the handler (you can pattern match on exception constructors with <code>case</code> as
well, though not <em>raised</em> exceptions). Thus, the behavior of <code>factException n</code>
is to be extensionally equivalent to <code>raise Return (fact n)</code>.</p>
<p>For an abstract idea of a potential use case, consider some recursive function 
<code>f</code> that carries out some sequence of calculations, with a potential for error.
We might be interested in how many recursive calls such a function makes when it
ultimately fails - however, if we were to return the number of recursive calls,
we would constrain the return type to be <code>int</code>, or barring that, some datatype
that could be either a valid result (say, <code>Valid res</code>) or a signal for failure,
with a line number (say, <code>Fail line</code>). We might desire that on a fail, execution
actually stops, however. We could then simply raise the exception <code>Crash line</code>,
which, as a raised exception, has a polymorphic type. As such, exceptions allow
us to propagate back information <em>without altering types</em>, which can be
convenient for our purposes.</p>
<p>For a concrete example of using such exceptions, see the next section.</p>
<h2 id="exception-handling-style"><a class="header" href="#exception-handling-style">Exception Handling Style</a></h2>
<p>In the previous section, we discussed how continuation passing style could be
used to devise complicated control flow schemas, in some instances being based
around the idea of a <em>success</em> and <em>failure</em> continuation, which could both
potentially execute disjoint sets of instructions. With continuations, we can
relate them to a common other construct in programming languages, that being a
<em>goto</em>. With a goto, we abandon whatever we are currently in the process of
doing in favor of something else. In this, we can see that continuations and
exceptions share similar characteristics, of being able to just &quot;stop&quot; execution
in favor of some other route.</p>
<p>Consider the knapsack example from the previous section. We will now implement a
solution to the knapsack problem using exception handling style.</p>
<pre><code class="language-sml">exception Failure

type weight = int
type value = int

(* knapsackEHS : 
 *            (value * weight) list -&gt; 
 *            value -&gt; 
 *            weight -&gt; 
 *            ((value * weight) list -&gt; 'a) -&gt; 
 *            'a 
 * REQUIRES: The weights and values of the elements in L are strictly positive.
 * ENSURES: knapsackEHS L minVal maxWeight sc fc ~= sc L' for some L' that only
 * contains elements of L, such that the total value of L' &gt;= minVal and the 
 * total weight of L' &lt;= maxWeight, if such an L' exists. If no such L' exists, 
 * then it should be equivalent to raise Failure.
 *)

fun knapsackEHS 
  (L : (value * weight) list) 
  (minVal : value) 
  (maxWeight : weight) 
  (sc : (value * weight) list -&gt; 'a) 
  : 'a =
  case L of
    [] =&gt; if minVal &lt;= 0 andalso maxWeight &gt;= 0 then sc [] 
                                                else raise Failure
  | (v, w)::xs =&gt; if maxWeight &lt; 0 then raise Failure
                                   else
    knapsackEHS ((v, w)::xs) (minVal - v) (maxWeight - w)  (fn L' =&gt; sc ((v, w)::L')) 
    handle Failure =&gt; knapsackEHS xs minVal maxWeight sc
</code></pre>
<p>It should be apparent that this function shares very close similarities to
<code>knapsackCPS</code>, with the exception<a href="#footnote1"> <sup> [1] </sup> </a> of
omitting the failure continuation for raising the <code>Failure</code> exception. In fact,
we can claim that <code>knapsackCPS L minVal maxWeight sc fc ~= knapsackEHS L minVal maxWeight sc handle Failure =&gt; fc ()</code>, for all relevant values. Take a moment to
assure yourself that this is the case. The code does not look very different,
with the largest change being the recursive case, where the failure continuation
has instead been offloaded to a handler.</p>
<p>Recall that we can think of the recursive call in the knapsack problem as a
&quot;choice&quot; to &quot;keep&quot; or &quot;not keep&quot; the item at the head of the list. We said
previously that, arbitrarily, we could commit to the choice of &quot;keep&quot;, with a
provision in the failure continuation to instead &quot;not keep&quot;, should that failure
continuation ever be executed. When evaluating the expression <code>knapsackEHS ((v, w)::xs) (minVal - v) (maxWeight - w) (fn L' =&gt; sc ((v, w)::L'))</code>
<a href="#footnote2"> <sup> [2] </sup> </a>, we know that one of two things can
happen - it can either <em>succeed</em> or <em>fail</em>. Now, however, our definition of
failure is different - instead of calling its failure continuation, an instance
of <code>knapsackEHS</code> which fails should instead raise <code>Failure</code>. Thus, it is exactly
the right thing to do to do what we would ordinarily do upon a failure, should
our call to <code>knapsackEHS</code> raise <code>Failure</code>.</p>
<p>Note, however, that in this implementation we put a slight amount more burden on
the user, since the ill-defined behavior of this function now results in a
raised <code>Failure</code>, instead of just invoking <code>fc ()</code>, for some pre-defined <code>fc</code>
that we input. This offers us the same advantages, however, since the return
types of <code>sc</code> and <code>fc</code> in <code>knapsackCPS</code> must be the same. As such, if we want
<code>knapsackCPS</code> to return some indicative value (without using an option type), we 
might not have an appropriate return value for the failure case. Thus,
<code>knapsackEHS</code> might have the behavior we're looking for, since the type of
<code>raise Failure</code> allows us to &quot;unconstrain&quot; the type of our success. In the
general case, however, we will not make heavy usage of exception handling style,
in favor of continuation passing style, which can be cleaner.</p>
<p>This is not the most committed that we could have made <code>knapsackEHS</code>, when
converting to exception handling style - we could have also represented <em>success
continuations</em> with a raised exception, an <code>exception Success of (int * int) list</code>. We will not cover such an implementation in this chapter, but we invite
the reader to try it out.</p>
<h3 id="footnotes"><a class="header" href="#footnotes">Footnotes</a></h3>
<p><a id="footnote1"> [1]: We're funny.
<a id="footnote2"> [2]: Say that five times fast.</p>
<h2 id="conclusions"><a class="header" href="#conclusions">Conclusions</a></h2>
<p>In this chapter, we explored <em>exceptions</em>, which allow us to have quick
transfers of control flow, albeit in a less &quot;controlled&quot; fashion than ways that
we have seen in the past. The success of so-called <em>exception handling style</em> is
heavily contingent on intelligent placement and consideration of <em>handlers</em>,
which decide where control is transferred to. We also have seen that we have a
way of passing information back <em>through</em> the raised exception, which allows us
to have a more powerful manner of communication than just an indicator of
failure. Exceptions ultimately allow us a robust and type-safe way to deal with 
run-time errors in our programs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../concepts/cps.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../concepts/mods.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../concepts/cps.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../concepts/mods.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
