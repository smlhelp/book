<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-concepts/modules/functors">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Functors | SML Help</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://smlhelp.github.io/book/docs/concepts/modules/functors/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Functors | SML Help"><meta data-rh="true" name="description" content="By Cooper Pierce and Brandon Wu, February 2021"><meta data-rh="true" property="og:description" content="By Cooper Pierce and Brandon Wu, February 2021"><link data-rh="true" rel="canonical" href="https://smlhelp.github.io/book/docs/concepts/modules/functors/"><link data-rh="true" rel="alternate" href="https://smlhelp.github.io/book/docs/concepts/modules/functors/" hreflang="en"><link data-rh="true" rel="alternate" href="https://smlhelp.github.io/book/docs/concepts/modules/functors/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://XNI9A5Z2CN-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="SML Help" href="/book/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/book/assets/css/styles.01f25c8a.css">
<link rel="preload" href="/book/assets/js/runtime~main.3cbcc436.js" as="script">
<link rel="preload" href="/book/assets/js/main.357cef8a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/book/"><b class="navbar__title text--truncate">SML Help</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/smlhelp/book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/book/docs/">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/book/docs/start/install/">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/book/docs/types/">Types</a><button aria-label="Toggle the collapsible sidebar category &#x27;Types&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/book/docs/libs/basis/">Libraries</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/book/docs/debugging/errors/">Debugging</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/book/docs/concepts/basic/">Concepts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/basic/">Basics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Basics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/recursion/">Recursion and Induction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Recursion and Induction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/asymptotic/">Asymptotic Analysis</a><button aria-label="Toggle the collapsible sidebar category &#x27;Asymptotic Analysis&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/book/docs/concepts/poly/">Parametric Polymorphism</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/hof/">Higher Order Functions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Higher Order Functions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/control-flow/">Control Flow</a><button aria-label="Toggle the collapsible sidebar category &#x27;Control Flow&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/book/docs/concepts/modules/">Modules</a><button aria-label="Toggle the collapsible sidebar category &#x27;Modules&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/book/docs/concepts/modules/functors/">Functors</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/book/docs/concepts/sequences/">Sequences</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/lazy/">Lazy Evaluation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lazy Evaluation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/book/docs/concepts/imperative/">Imperative Programming</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/book/docs/concepts/beyond/">Beyond</a><button aria-label="Toggle the collapsible sidebar category &#x27;Beyond&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/book/docs/examples/basics/">Examples</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/book/docs/about/">About</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/book/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Concepts</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/book/docs/concepts/modules/"><span itemprop="name">Modules</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Functors</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Functors</h1><p><em>By Cooper Pierce and Brandon Wu, February 2021</em></p><p>We have so far discussed the usage of modules for explicitly structuring our code, in that we are afforded a degree of <em>modularity</em> in how the different components of some software can fit together. We have used language like &quot;swapping out&quot; modules or &quot;substituting&quot; modules for one another, but this is very imprecise. What exactly do we mean when we say to swap one module for another? Certainly, it would be messy to have to go through our code and change every mention of <code>StructureA</code> for <code>StructureB</code>, and we would like to avoid some kind of global change that requires an extenuous amount of effort on the client&#x27;s part.</p><p>Going through and changing every mention of a particular structure in order to achieve &quot;modularization&quot; is akin to saying that using a particular higher-order function by replacing specifically what each function parameter is in each invocation is how we can achieve &quot;parameterization&quot; in the function argument. In reality, this does not offer any more versatility. In this chapter, we will discuss <em>functors</em>, which are akin to <em>higher-order modules</em>, which are allowed to take other modules in as arguments.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="functors-the-basics">Functors: The Basics<a class="hash-link" href="#functors-the-basics" title="Direct link to heading">​</a></h2><p>Firstly, consider the signature of a stack.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">signature</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> push </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> pop </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> option </span><span class="token class-name operator" style="color:#393A34">*</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> size </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Suppose that we would like to <em>extend</em> the definition of a stack such that it has a limit on how many elements that it contains. However, we don&#x27;t necessarily know which implementation of a stack to use - there could be several such existing implementations, so we would like to instead make our <code>BoundedStack</code> structure a <em>parameter of</em> an existing structure ascribing to <code>STACK</code>.</p><p>We will then use a very similar signature to <code>STACK</code> called <code>BOUNDED_STACK</code>, which is the exact same except for having an <code>exception Full</code> for use if a stack is given too many elements.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">signature</span><span class="token plain"> </span><span class="token class-name">BOUNDED_STACK</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exception</span><span class="token plain"> </span><span class="token class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> push </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> pop </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> option </span><span class="token class-name operator" style="color:#393A34">*</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> size </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We first consider the case where we have a hard limit of 10 items in a given stack.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">BoundedStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> BOUNDED_STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exception</span><span class="token plain"> </span><span class="token class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">push</span><span class="token plain"> S x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push S x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pop</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">size</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see that most of this code is duplicated - we have based the majority of the design of this <code>BoundedStack</code> in terms of <code>S</code>, which is the given implementation of a stack. The correctness of a <code>BoundedStack</code> is thus totally dependent on whether or not the given <code>S</code> is correct, but we achieve <em>modularity</em> in that we can freely swap out a structure ascribing to <code>STACK</code> for another when instantiating a given <code>BoundedStack</code>.</p><p>To put it concretely, suppose that we have two structures:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">Stack1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* some code here *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">Stack2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* some code here *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then we can create instances of the <code>BoundedStack</code> functor as follows:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>NOTE</strong>: SML functors are <em>generative</em>, meaning that applying the same functor to the same structure twice yields two unique structures. As such, if we had <code>structure BS1 = BoundedStack(Stack1)</code> and <code>structure BS2 = BoundedStack(Stack1)</code>, then the types <code>BS1.t</code> and <code>BS2.t</code> are recognized as being two distinct types, despite the fact that they are &quot;constructed&quot; in the same manner.</p><p><code>BoundedStack1</code> and <code>BoundedStack2</code> implement <code>BOUNDED_STACK</code>, so they all can access the fields of the <code>BOUNDED_STACK</code> signature. Presumably, the only change they display from <code>Stack1</code> and <code>Stack2</code> are in raising the exception <code>Full</code> when the stack is given more than ten elements.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="functors-syntactic-sugar">Functors: Syntactic Sugar<a class="hash-link" href="#functors-syntactic-sugar" title="Direct link to heading">​</a></h2><p>SML offers some &quot;syntactic sugar&quot; for functor arguments, allowing us to (seemingly) parameterize them by terms other than structures. It is a little unsavory to have to hard code the limit of the <code>BoundedStack</code> within the functor itself, rather than having it be parameterized by the limit itself, so we can actually also write the following:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">BoundedStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> limit </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> BOUNDED_STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exception</span><span class="token plain"> </span><span class="token class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">push</span><span class="token plain"> S x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push S x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pop</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">size</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The only difference is that instead of taking in a single <code>S : STACK</code>, we specify &quot;<code>structure S : STACK val limit : int</code>&quot; within the parentheses of the functor&#x27;s input. Note that there are no commas or delimiters other than spaces.</p><p>In reality, this is something of a lie. While this seems to give the impression that <code>BoundedStack</code> is taking in <em>two</em> things, a structure named <code>S</code> ascribing to <code>STACK</code> and a value of type int named <code>limit</code>, in reality functors can only take in other structures. This is thus <em>syntactic sugar</em> for the following code:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">BoundedStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UnnamedStructure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> limit </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> BOUNDED_STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> UnnamedStructure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* same code as before *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>open</code> keyword specifies to <em>open</em> the namespace within a given module, effectively promoting all contents of it to the top level. Thus, if we were to <code>open Stack1</code>, as per our previous example, we could write <code>push</code> instead of <code>Stack1.push</code>, <code>pop</code> instead of <code>Stack1.pop</code>, and so on and so forth. Thus, what this syntactic sugar does is specify to take in a <em>single structure</em> ascribing to a signature that <em>contains</em> a structure ascribing to <code>STACK</code> and an int-typed value, named <code>S</code> and <code>limit</code> respectively.</p><p><strong>CAUTION</strong>: This is a very important point to cognize! This can be the source of many frustrated hours of debugging due to a simple syntax error.</p><p>The reason why we must <code>open UnnamedStructure</code> in order to be able to use the same code is because we cannot say <code>S.push</code>, for instance, as we did in the original implementation of <code>BoundedStack</code>. We would instead have to specify <code>UnnamedStructure.S.push</code>, which is not what our previous code says. However, if we <code>open UnnamedStructure</code> first, the <code>S</code> structure is promoted to the top level, and we can now access it without first having to go through <code>UnnamedStructure</code>.</p><p>The reason for naming the input structure <code>UnnamedStructure</code> should hopefully now be clear. Indeed, it is a <em>phantom structure</em> of a sort, since in the syntactic sugar case, we never give it a name, and indeed we never really acknowledge its existence at all. Yet it is important to realize what is really happening, that there really <em>is</em> a structure being taken in as input, and then immediately opened for its contents.</p><p>What issues can occur if we forget about the existence of this syntactic sugar? Consider the following code:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">BoundedStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> BOUNDED_STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exception</span><span class="token plain"> </span><span class="token class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">push</span><span class="token plain"> S x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push S x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pop</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">size</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code <em>will not compile!</em> Can you see why?</p><p>The issue is that we have added a prefix of <code>structure</code> to <code>S : STACK</code> within the inputs. Even though we have only specified one field, not including the <code>limit</code> as a parameter, this will be interpreted as the following:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">BoundedStack</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UnnamedStructure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">S</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">STACK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> BOUNDED_STACK </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exception</span><span class="token plain"> </span><span class="token class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">push</span><span class="token plain"> S x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push S x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pop</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">size</span><span class="token plain"> S </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size S</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">BoundedStack2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BoundedStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Stack2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Thus, <code>BoundedStack</code> is no longer a functor taking in a structure ascribing to <code>STACK</code>, but a functor taking in a structure ascribing to <code>sig structure S: STACK end</code>. In other words, taking in a structure <em>containing</em> a structure ascrbing to <code>STACK</code>! Thus, the line <code>structure BoundedStack1 = BoundedStack(Stack1)</code> will not type-check, as <code>Stack1</code> does not ascribe to the same signature that <code>BoundedStack</code> is expecting. This one simple syntax error can be the source of much pain and frustration, so we caution the reader to be particular with their syntax, and mindful of what is really happening under the hood.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-study-typeclasses">Case study: Typeclasses<a class="hash-link" href="#case-study-typeclasses" title="Direct link to heading">​</a></h2><p>Certain types have some functionality or operation in common. Depending on the operation in question, we can say that these types fall into the same <em>typeclass</em>, which is a common interface consisting of a type and the desired operations. Note that typeclass membership is not a formally defined relationship, but instead a useful categorization that we use in order to classify types that we intend to parameterize some implementation over.</p><p>For a concrete example of a typeclass, consider the <code>ORDERED</code> typeclass.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">signature</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">t </span><span class="token class-name operator" style="color:#393A34">*</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>ORDERED</code> typeclass consists of those types that admit a <em>sensible ordering</em>, which we will not (and perhaps cannot) define. Thus, we can witness <code>int</code> and <code>string</code> as valid instances of the <code>ORDERED</code> typeclass with the following structures:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">IntOrder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">StringOrder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that it is useful, in this case, for our instances of the <code>ORDERED</code> typeclass to be <em>transparently ascribed</em>, since it is the whole point that we are aware of the type that the typeclass is associated with.</p><p><strong>NOTE</strong>: In actuality, we use transparent ascription as somewhat of a sledgehammer to avoid having to talk about a different language construct, namely <code>where</code> clauses. A <code>where</code> clause modifies a signature containing an abstract type, and concretely specifies what that type should be. For instance, we could discuss the signature <code>signature ORDERED type t end where type t = int</code>. A structure ascribing to this signature would &quot;publish&quot; the details of the type <code>t</code> (which is really an <code>int</code>), the same way that transparent ascription would. With <code>where</code> clauses, however, if there are multiple abstract types, we can be selective about which ones that are made &quot;transparent&quot;. For the purposes of this chapter, however, we will largely avoid <code>where</code> clauses.</p><p>These definitions come very naturally from the fact that the <code>String</code> and <code>Int</code> libraries included with the Standard ML basis library already implement <code>compare</code> fields, however we can also define types such as <code>int list</code> to be instances of <code>ORDERED</code>:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">structure</span><span class="token plain"> </span><span class="token class-name">IntListOrder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> int list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compare</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EQUAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare xs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GREATER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ys</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> compare xs ys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> LESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> GREATER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This structure defines a <em>lexicographic ordering</em> on int lists, using the fact that values of type <code>int</code> are already ordered. It prioritizes the relative comparison of the corresponding elements of both lists first, and then the length (akin to how a dictionary is ordered).</p><p>Indeed, we can take this one step further and see that lexicographic orderings form a <em>functor</em>, in that we can parameterize the ordering of some type of list, given that we can order the elements of the list. Like a higher-order function, this saves us from having to repeat the same code over and over to declare <code>StringListOrder</code> and <code>CharListOrder</code> structures, instead encapsulating the common pattern. We can implement the <code>LexicListOrder</code> functor as follows:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">LexicListOrder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">O </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> O</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compare</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EQUAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare xs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GREATER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">xs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ys</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> O</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> compare xs ys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> LESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> GREATER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that since an instantiation of the <code>LexicListOrder</code> functor is itself a structure ascribing to <code>ORDERED</code>, it can be &quot;passed in&quot; as input to <em>itself</em>, resulting in <em>any</em> type of nested list being an instance of <code>ORDERED</code>, so long as the base type is also an instance of <code>ORDERED</code>.</p><p>It is also useful to note that <em>equality types</em> in Standard ML are essentially a language-supported typeclass, akin to inbuilt support for the following signature:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">signature</span><span class="token plain"> </span><span class="token class-name">EQ</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> equal </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">t </span><span class="token class-name operator" style="color:#393A34">*</span><span class="token class-name"> t </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The operations for <code>equal</code> for each &quot;instance&quot; of the typeclass are instead defined by Standard ML itself, and not user-defined. Thus, we can think of the equality operator <code>=</code> as simply invoking the <code>T.equal</code> method for the proper typeclass <code>T</code>, defined by the type that is being compared for equality.</p><p>In this next section, we will explore a concrete use for typeclasses when designing functors.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-study-red-black-trees">Case study: Red-black trees<a class="hash-link" href="#case-study-red-black-trees" title="Direct link to heading">​</a></h2><p>Typeclasses can be important when we are attempting to place some greater constraint on the types that may instantiate some universal type. In certain cases, we do not want the types that we are considering to truly be <em>any</em> type, but any of a limited subset of types that share some common characteristic or implement some operation. We will study the use of <em>red-black trees</em> as the underlying data structure for dictionaries.</p><p>A dictionary is a simple data structure that maps keys to values. Consider its signature given below.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">signature</span><span class="token plain"> </span><span class="token class-name">DICT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> dict</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> insert </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> dict </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> key </span><span class="token class-name operator" style="color:#393A34">*</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> dict</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> lookup </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> dict </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> key </span><span class="token class-name operator" style="color:#393A34">-&gt;</span><span class="token class-name"> </span><span class="token class-name variable" style="color:#36acaa">&#x27;a</span><span class="token class-name"> option</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is a well-known fact that, utilizing a kind of <em>balanced binary tree</em> data structure, dictionaries can be implemented with an <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em">g</span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> <code>insert</code> and <code>lookup</code> operation, as opposed to <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> for other data structures such as lists. While there are many different implementations of balanced binary trees, we will consider a particular variant known as <em>red-black trees</em>.</p><blockquote><p><strong>[Red-black tree]</strong>: A variant of self-balancing binary tree that ensures logarithmic search and insert time. It is named because of its nodes, which are marked as either <em>red</em> or <em>black</em>. Furthermore, it obeys the following properties:</p><ol><li>All leaves are black.</li><li>The children of a red node must be black.</li><li>Any path from a given node to a leaf node must go through the same number of black nodes.</li></ol><p>Note that as a variant of binary search tree, a red-black tree must also satisfy the invariant that the key stored at a node must be greater than or equal to every key in the left subtree, and less than or equal to every key in the right subtree.</p></blockquote><p>It is easy to reason about why this schema ensures that we have the proper asymptotic bound for search - the third property in particular ensures that, for any path from the root, the length of the longest path from the root to a leaf is at most twice that of the shortest path. This is because the longest such path you can construct from the root to a leaf (minimizing black nodes) is by alternating black and red nodes.</p><p>This means that a given red-black tree is not as strictly balanced as some other variants (for instance, AVL trees), however it is always <em>approximately</em> balanced.</p><p>We would like to create a structure for red-black tree dictionaries. There are some options that we have - we could simply hard-code a <code>TypeRedBlackDict :&gt; DICT</code> for any type <code>Type</code>, except that this would entail quite a bit of repeated code (and exertion on our part). Another solution would be to make the type of <code>&#x27;a dict</code> doubly-polymorphic instead - something like an <code>(&#x27;a, &#x27;b) dict</code>, where <code>&#x27;a</code> is the type of the dict&#x27;s keys and <code>&#x27;b</code> the type of its contents. However, then we lose the guarantee that <code>&#x27;a</code> is a type that supports comparison, which means that we cannot satisfy the tree&#x27;s invariants.</p><p>The solution we will turn to is exactly similar to that as discussed in the previous section - we will instead design a <code>RedBlackDict</code> functor that takes in a typeclass implementing <code>ORDERED</code>, and exports a structure whose keys are the type of the given typeclass. We thus will define our functor with the following preliminaries:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">RedBlackDict</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Key </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> DICT </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">datatype</span><span class="token plain"> </span><span class="token class-name">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Red </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">datatype</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">color </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Leaf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because we take as input a <code>Key</code> structure ascribing to <code>ORDERED</code>, we have access to the <code>Key.compare</code> function, which we will use when inserting into our dictionary. We define a <code>color</code> type (which only consists of the constant constructors <code>Red</code> and <code>Black</code>) for tagging the nodes of the red-black tree (leaves are considered to be black).</p><blockquote><p><em>Note: We use the <code>where</code> syntax to indicate that the <code>type key</code> will be the same as <code>Key.t</code> to the outside world. This is important because our <code>RedBlackDict</code> is opaquely ascribed, meaning that without this syntax, we wouldn&#x27;t know what the type of <code>key</code> is, and thus could not actually add any keys! While before we avoided using <code>where</code> by just making the ascription transparent, we don&#x27;t want to do that here, because we don&#x27;t want the outside world to mess with our red-black tree and potentially mess up the invariant!</em></p></blockquote><p>The question becomes: how should we implement insert? We cannot be so naive as to simply insert as we would in an ordinary binary search tree, as this would quickly cause problems with our invariants. In particular, we must be mindful of the <em>black height</em> invariant, saying that all paths to leaves must have the same number of black nodes on them.</p><p>The easiest case to tackle for insert is the <code>Leaf</code> case. How should we finish the definition of <code>fun insert Leaf (k, v) = </code>? Well, clearly we must insert a <code>Node(Leaf, (c, (k, v)), Leaf)</code> for some color <code>c</code>. Note that since a <code>Leaf</code> is considered to be colored black, if we choose <code>c</code> to be <code>Black</code>, we will run into issues with our black height invariant - we have replaced a <code>Leaf</code> (a subtree of black height 1) with a subtree of black height 2! This will disproportionately affect the black height of paths ending in this subtree, thus causing the invariant to be violated.</p><p>Thus, the only sensible choice we can commit is to insert as a <code>Red</code> node. The astute reader may see that this will quickly cause issues - we will address this shortly. Thus, we can write</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> insert </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>How should we handle the <code>Node</code> case? Well, insertion really only happens at the leaves - the only thing that we can do at a <code>Node</code> is to propagate the change throughout the tree until it gets to where it needs to be. We have seen that this schema of an &quot;always-red&quot; insertion maintains the black-height invariant, however there is the <em>red-children</em> invariant as well - the children of a red node must themselves be red. This invariant is the one that we are not respecting, with our current schema.</p><p>So we only run into an issue when we insert into the tree such that the new node is the child of a red node. Furthermore, we know that, if the tree that we are inserting into is truly a red-black tree, it must respect the red-children invariant, and thus the the parent of the inserted node must itself have a black parent. Thus, there can only be four cases for the &quot;site&quot; of the insertion:</p><figure class="center_wFZg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="343.301" height="386.84" viewBox="-72 -72 257.476 290.13"><defs><path id="j" d="M4.563-6.386c.01-.03.03-.11.03-.13 0-.08-.06-.12-.12-.12s-.07.01-.19.16C3.518-5.45 2.82-5.38 2.532-5.35c-.05.01-.16.02-.16.19 0 .119.12.119.16.119.149 0 .637-.06 1.105-.409L2.461-.727c-.08.319-.16.418-.937.418h-.08c-.169 0-.278 0-.278.19 0 .119.11.119.15.119.427 0 .876-.03 1.304-.03.439 0 .897.03 1.335.03.07 0 .2 0 .2-.19 0-.119-.1-.119-.26-.119h-.08c-.129 0-.298-.01-.428-.02-.219-.03-.279-.04-.279-.18 0-.059.02-.149.03-.188l1.425-5.69Z"></path><path id="k" d="M1.514-.737c.498-.857 1.226-1.265 1.535-1.445 1.534-.867 2.44-1.484 2.44-2.77 0-1.145-.777-1.683-1.554-1.683-1.474 0-2.291 2.012-2.291 2.66 0 .2.06.628.508.628.787 0 1.205-1.196 1.205-1.575 0-.179-.09-.528-.219-.528a.11.11 0 0 0-.11.11c0 .02 0 .04.01.06.06.12.1.249.1.368 0 .29-.368 1.345-.976 1.345-.12 0-.22-.05-.22-.328 0-.648.748-2.52 1.963-2.52.409 0 .877.268.877 1.095 0 1.445-.867 2.281-1.853 2.87-.448.268-.867.507-1.285 1.025C.946-.588.837.11.837.12c0 .1.1.1.15.1.119 0 .139-.02.169-.13.08-.28.259-.638.558-.638.318 0 .597.2.846.369.26.179.568.398.967.398C4.672.22 5.13-1.514 5.13-1.624c0-.1-.08-.1-.15-.1-.12 0-.13.01-.169.17-.14.408-.528 1.076-1.196 1.076-.279 0-.667-.08-.826-.12-.36-.08-.748-.17-1.057-.17-.11 0-.199.02-.219.03Z"></path><path id="l" d="M3.029-3.487c-.17 0-.26 0-.26.21 0 .099.08.099.25.099h.279c.189 0 .767.02.767.827 0 .18-.09 1.165-.608 1.763C3.178-.249 2.72 0 2.271 0c-.498 0-.996-.299-1.016-1.036a.493.493 0 0 0 .558-.478c0-.16-.11-.32-.339-.32-.508 0-.528.599-.528.778 0 .677.479 1.275 1.325 1.275 1.256 0 2.511-1.046 2.511-2.241 0-.19-.04-.917-.797-1.266C5.021-3.636 5.6-4.543 5.6-5.3c0-.847-.648-1.335-1.425-1.335-1.185 0-2.191 1.046-2.191 1.893 0 .348.189.637.557.637s.827-.348.827-.846c0-.19-.11-.499-.229-.499a.11.11 0 0 0-.11.11c0 .03.01.05.04.11.01.01.08.14.08.289 0 .338-.319.617-.608.617-.199 0-.259-.19-.259-.368 0-.787.907-1.724 1.873-1.724.369 0 .847.18.847.897 0 .16-.1 2.032-1.743 2.032h-.23Z"></path><path id="m" d="M4.115-1.943c.04-.15.04-.17.04-.199 0-.259-.24-.269-.27-.269-.298 0-.358.26-.398.428-.03.1-.409 1.594-.419 1.654-.727-.259-.318-.13-.607-.229-.369-.11-.538-.11-.757-.11-.12 0-.14 0-.27.01 2.69-2.49 3.268-5.708 3.268-5.718 0-.21-.169-.26-.269-.26-.289 0-.348.23-.418.499-.329 1.245-.767 2.44-1.475 3.597C1.753-1.265.867-.568.827-.538c-.07.03-.389.2-.389.359 0 .04.07.169.15.169.06 0 .209-.12.319-.2.09-.079.179-.149.767-.149.18 0 .378 0 .727.11.13.05.369.15.588.23L2.62 1.464c-.04.149-.04.169-.04.209 0 .209.17.259.27.259.189 0 .318-.11.378-.339L3.597.139c.06.01.139.01.199.01.279 0 .926-.13.926-.288 0-.05-.06-.17-.15-.17-.02 0-.039 0-.139.04-.179.07-.428.11-.597.11-.07 0-.11 0-.16-.01l.439-1.774Z"></path><path id="f" d="M8.07-6.785c.01-.04.02-.1.02-.139 0-.02-.01-.1-.11-.1-.02 0-.07 0-.16.11l-.627.737c-.428-.687-1.006-.847-1.504-.847-2.053 0-4.195 2.242-4.195 4.583C1.494-.807 2.56.22 3.935.22c1.943 0 3.029-2.132 3.029-2.61 0-.1-.1-.1-.15-.1-.06 0-.13 0-.159.08C6.147-.727 4.902-.09 4.075-.09c-.837 0-1.714-.558-1.714-1.972 0-.618.25-2.182 1.046-3.278.678-.917 1.594-1.375 2.361-1.375 1.056 0 1.415.957 1.415 1.823 0 .26-.05.578-.05.608 0 .1.1.1.15.1.11 0 .14-.01.179-.18l.608-2.42Z"></path><path id="g" d="M3.477-.588c.11.488.478.698.827.698.368 0 .578-.25.727-.558.18-.379.299-.957.299-.977 0-.1-.08-.1-.15-.1-.119 0-.129.01-.189.23-.14.558-.328 1.185-.667 1.185-.26 0-.26-.269-.26-.408 0-.07 0-.23.07-.508l.678-2.71c.04-.14.04-.16.04-.21 0-.208-.17-.258-.27-.258-.318 0-.388.338-.398.388-.189-.428-.508-.587-.827-.587-1.105 0-2.281 1.514-2.281 2.968 0 .847.458 1.545 1.205 1.545.36 0 .797-.21 1.196-.698Zm.538-2.53-.468 1.883C3.467-.917 2.849-.11 2.3-.11c-.468 0-.548-.587-.548-.886 0-.498.31-1.664.489-2.082.249-.608.707-1.106 1.115-1.106.439 0 .688.518.688.936 0 .02-.01.07-.03.13Z"></path><path id="i" d="M2.381-2.301c.299 0 .966-.03 1.445-.22.787-.318.787-.966.787-1.036 0-.458-.369-.846-1.007-.846-1.046 0-2.47 1.006-2.47 2.77C1.136-.738 1.614.11 2.56.11c1.276 0 2.103-.997 2.103-1.146 0-.05-.08-.16-.16-.16-.04 0-.05.01-.13.11-.737.937-1.623.976-1.793.976-.647 0-.757-.707-.757-1.095 0-.38.1-.827.17-1.096h.388Zm-.329-.22c.429-1.633 1.455-1.663 1.554-1.663.399 0 .628.269.628.607 0 1.056-1.644 1.056-1.972 1.056h-.21Z"></path><path id="h" d="M2.46-1.963c.44.1.887.2.887.738 0 .318-.269 1.115-1.295 1.115-.219 0-.797-.05-.956-.557.508-.05.508-.469.508-.489 0-.189-.13-.318-.339-.318-.229 0-.508.169-.508.617 0 .608.578.967 1.285.967 1.495 0 1.873-1.216 1.873-1.674 0-.867-.777-1.046-1.185-1.136-.28-.06-.638-.14-.638-.568 0-.239.21-.916 1.006-.916.27 0 .638.1.748.488a.436.436 0 0 0-.399.408c0 .11.06.28.299.28.17 0 .428-.12.428-.549 0-.458-.408-.846-1.066-.846A1.512 1.512 0 0 0 1.534-2.93c0 .767.648.907.927.966Z"></path><path id="b" d="M3.975-2.88c0-1.015-.727-1.713-1.644-1.713-.647 0-1.096.16-1.564.429l.06.657c.518-.368 1.016-.498 1.504-.498.469 0 .867.399.867 1.136v.428c-1.494.02-2.76.439-2.76 1.315C.438-.697.708.11 1.574.11c.14 0 1.076-.02 1.654-.469V0h.747v-2.88Zm-.777 1.565c0 .19 0 .438-.339.628-.289.179-.667.189-.777.189-.478 0-.926-.23-.926-.648 0-.697 1.614-.767 2.042-.787v.618Z"></path><path id="c" d="M1.564-6.914H.817V0h.777v-.458c.24.219.668.568 1.335.568.996 0 1.853-.997 1.853-2.332 0-1.235-.677-2.311-1.614-2.311-.388 0-1.006.1-1.604.588v-2.97Zm.03 3.577c.16-.24.518-.588 1.066-.588.588 0 1.345.428 1.345 1.703 0 1.295-.837 1.724-1.445 1.724-.388 0-.717-.18-.966-.638v-2.201Z"></path><path id="d" d="M4.085-4.164c-.588-.34-.927-.429-1.535-.429C1.166-4.593.36-3.387.36-2.212.359-.976 1.265.11 2.51.11c.538 0 1.086-.14 1.623-.509l-.06-.667a2.457 2.457 0 0 1-1.553.538c-.827 0-1.385-.717-1.385-1.694 0-.777.368-1.733 1.424-1.733.518 0 .857.08 1.405.438l.12-.647Z"></path><path id="e" d="M4.324-6.914h-.747v2.929a2.295 2.295 0 0 0-1.455-.548c-.986 0-1.763 1.036-1.763 2.321C.359-.907 1.126.11 2.072.11c.329 0 .917-.09 1.475-.628V0h.777v-6.914Zm-.777 5.53c0 .139-.01.318-.33.607-.228.2-.477.279-.736.279-.618 0-1.345-.468-1.345-1.704 0-1.315.857-1.723 1.444-1.723.449 0 .748.229.967.548v1.992Z"></path><path id="a" d="M4.682-2.072h2.7c.1 0 .528 0 .528-.419s-.428-.418-.528-.418h-2.7v-2.71c0-.1 0-.528-.418-.528s-.418.428-.418.528v2.71h-2.71c-.1 0-.528 0-.528.418s.428.419.528.419h2.71v2.71c0 .1 0 .528.418.528s.418-.429.418-.528v-2.71Z"></path></defs><path fill="#fff" d="M-72-72h257.476v290.13H-72z"></path><path d="M27.719-43.262a7.442 7.442 0 0 0-14.883 0 7.445 7.445 0 0 0 7.441 7.446 7.445 7.445 0 0 0 7.442-7.446Z"></path><path d="M27.719-43.262a7.442 7.442 0 0 0-14.883 0 7.445 7.445 0 0 0 7.441 7.446 7.445 7.445 0 0 0 7.442-7.446Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M8.844-8.887a7.445 7.445 0 0 0-7.446-7.441 7.442 7.442 0 0 0-7.441 7.441 7.443 7.443 0 1 0 14.887 0Z" fill="red"></path><path d="M8.844-8.887a7.445 7.445 0 0 0-7.446-7.441 7.442 7.442 0 0 0-7.441 7.441 7.443 7.443 0 1 0 14.887 0Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-6.484 26.047a8.318 8.318 0 0 0-8.317-8.317 8.318 8.318 0 0 0-8.316 8.317 8.315 8.315 0 0 0 8.316 8.316 8.315 8.315 0 0 0 8.317-8.316Z" fill="red"></path><path d="M-6.484 26.047a8.318 8.318 0 0 0-8.317-8.317 8.318 8.318 0 0 0-8.316 8.317 8.315 8.315 0 0 0 8.316 8.316 8.315 8.315 0 0 0 8.317-8.316Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="23.488" y="-43.261" xlink:href="#a" fill="#fff" transform="translate(-42.55 71.8)"></use><use x="20.277" y="-43.261" xlink:href="#b" transform="translate(-48.315 104.559)"></use><use x="20.277" y="-43.261" xlink:href="#c" transform="translate(-26.809 104.559)"></use><use x="20.277" y="-43.261" xlink:href="#d" transform="translate(-4.893 71.8)"></use><use x="20.277" y="-43.261" xlink:href="#e" transform="translate(16.305 34.376)"></use><path d="M16.598-36.563 5.558-16.456" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M5.172-15.758c.656-.777 1.484-1.46 2.672-2.172-1.364.617-2.063.235-2.27-1.246.035 1.383-.097 2.45-.402 3.418Z"></path><path d="M5.172-15.758c.656-.777 1.484-1.46 2.672-2.172-1.364.617-2.063.235-2.27-1.246.035 1.383-.097 2.45-.402 3.418Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-1.816-1.953-8.985 19.371" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-11.133 18.14c.598-.816 1.38-1.554 2.516-2.343-1.317.707-2.04.371-2.352-1.09.13 1.375.074 2.45-.164 3.434Z"></path><path d="M-11.133 18.14c.598-.816 1.38-1.554 2.516-2.343-1.317.707-2.04.371-2.352-1.09.13 1.375.074 2.45-.164 3.434Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-17.457 34.14-6.797 20.712" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-24.504 55.61c.5-.887 1.191-1.708 2.227-2.626-1.227.856-1.985.606-2.461-.808.289 1.351.355 2.422.234 3.433Z"></path><path d="M-24.504 55.61c.5-.887 1.191-1.708 2.227-2.626-1.227.856-1.985.606-2.461-.808.289 1.351.355 2.422.234 3.433Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-12.05 34.11 6.32 18.527" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-5.473 53.39c-.132-1.003-.078-2.077.196-3.433-.461 1.422-1.22 1.68-2.453.836 1.046.906 1.746 1.723 2.257 2.598Z"></path><path d="M-5.473 53.39c-.132-1.003-.078-2.077.196-3.433-.461 1.422-1.22 1.68-2.453.836 1.046.906 1.746 1.723 2.257 2.598Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m4.594-1.945 11.195 24.34" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M16.125 23.117c-.238-.988-.293-2.058-.156-3.437-.317 1.46-1.04 1.797-2.356 1.086 1.133.793 1.914 1.53 2.512 2.351Z"></path><path d="M16.125 23.117c-.238-.988-.293-2.058-.156-3.437-.317 1.46-1.04 1.797-2.356 1.086 1.133.793 1.914 1.53 2.512 2.351Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m24.262-36.738 12.031 19.703" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M36.707-16.355c-.348-.954-.527-2.012-.555-3.395-.144 1.488-.824 1.902-2.21 1.352 1.218.656 2.078 1.296 2.765 2.043Z"></path><path d="M36.707-16.355c-.348-.954-.527-2.012-.555-3.395-.144 1.488-.824 1.902-2.21 1.352 1.218.656 2.078 1.296 2.765 2.043Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M-47.664-44.18h37.523v-13.449h-37.523Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g transform="translate(-64.623 -4.238)"><use x="20.277" y="-43.261" xlink:href="#f"></use><use x="27.406" y="-43.261" xlink:href="#g"></use><use x="32.498" y="-43.261" xlink:href="#h"></use><use x="36.572" y="-43.261" xlink:href="#i"></use><use x="44.719" y="-43.261" xlink:href="#j"></use></g><path d="M146.844-43.133a7.443 7.443 0 0 0-7.446-7.441 7.442 7.442 0 0 0 0 14.883 7.443 7.443 0 0 0 7.446-7.442Z"></path><path d="M146.844-43.133a7.443 7.443 0 0 0-7.446-7.441 7.442 7.442 0 0 0 0 14.883 7.443 7.443 0 0 0 7.446-7.442Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M122.558-8.758a7.442 7.442 0 0 0-7.441-7.441 7.443 7.443 0 1 0 0 14.887 7.445 7.445 0 0 0 7.441-7.446Z" fill="red"></path><path d="M122.558-8.758a7.442 7.442 0 0 0-7.441-7.441 7.443 7.443 0 1 0 0 14.887 7.445 7.445 0 0 0 7.441-7.446Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="139.4" y="-43.133" xlink:href="#b" transform="translate(-42.91 71.8)"></use><path d="M139.664 26.176a8.315 8.315 0 0 0-8.316-8.317c-4.594 0-8.317 3.723-8.317 8.317s3.723 8.316 8.317 8.316a8.315 8.315 0 0 0 8.316-8.316Z" fill="red"></path><path d="M139.664 26.176a8.315 8.315 0 0 0-8.316-8.317c-4.594 0-8.317 3.723-8.317 8.317s3.723 8.316 8.317 8.316a8.315 8.315 0 0 0 8.316-8.316Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="142.61" y="-43.133" xlink:href="#a" fill="#fff" transform="translate(-15.524 71.8)"></use><use x="139.4" y="-43.133" xlink:href="#c" transform="translate(-21.404 104.559)"></use><use x="139.4" y="-43.133" xlink:href="#d" transform="translate(.513 104.559)"></use><use x="139.4" y="-43.133" xlink:href="#e" transform="translate(21.71 34.376)"></use><path d="m134.992-36.89-14.89 21.078" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M119.64-15.16c.739-.7 1.637-1.285 2.899-1.86-1.422.461-2.074 0-2.117-1.492-.121 1.38-.371 2.422-.781 3.352Z"></path><path d="M119.64-15.16c.739-.7 1.637-1.285 2.899-1.86-1.422.461-2.074 0-2.117-1.492-.121 1.38-.371 2.422-.781 3.352Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M111.918-1.816 100.75 22.406" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M100.414 23.133c.601-.824 1.378-1.559 2.511-2.356-1.312.711-2.039.38-2.351-1.082.133 1.375.078 2.45-.16 3.438Z"></path><path d="M100.414 23.133c.601-.824 1.378-1.559 2.511-2.356-1.312.711-2.039.38-2.351-1.082.133 1.375.078 2.45-.16 3.438Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m118.336-1.828 9.004 19.379" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M127.676 18.273c-.238-.988-.297-2.058-.168-3.437-.309 1.46-1.031 1.797-2.352 1.094 1.137.789 1.918 1.523 2.52 2.343Z"></path><path d="M127.676 18.273c-.238-.988-.297-2.058-.168-3.437-.309 1.46-1.031 1.797-2.352 1.094 1.137.789 1.918 1.523 2.52 2.343Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m128.613 34.242-6.281 18.52" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M122.078 53.52c.507-.88 1.207-1.696 2.25-2.606-1.235.844-1.989.59-2.453-.832.277 1.355.332 2.43.203 3.438Z"></path><path d="M122.078 53.52c.507-.88 1.207-1.696 2.25-2.606-1.235.844-1.989.59-2.453-.832.277 1.355.332 2.43.203 3.438Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m133.988 34.273 6.797 20.825" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M141.03 55.855c-.12-1.007-.05-2.078.243-3.43-.48 1.415-1.238 1.66-2.461.802 1.031.921 1.723 1.746 2.219 2.628Z"></path><path d="M141.03 55.855c-.12-1.007-.05-2.078.243-3.43-.48 1.415-1.238 1.66-2.461.802 1.031.921 1.723 1.746 2.219 2.628Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m144.121-37.125 16.168 20.586" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M160.781-15.91c-.457-.906-.758-1.938-.949-3.309.031 1.496-.594 1.989-2.04 1.602 1.29.508 2.22 1.047 2.99 1.707Z"></path><path d="M160.781-15.91c-.457-.906-.758-1.938-.949-3.309.031 1.496-.594 1.989-2.04 1.602 1.29.508 2.22 1.047 2.99 1.707Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M76.863-44.05h37.524V-57.5H76.863Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g transform="translate(-59.217 -4.238)"><use x="139.4" y="-43.133" xlink:href="#f"></use><use x="146.528" y="-43.133" xlink:href="#g"></use><use x="151.62" y="-43.133" xlink:href="#h"></use><use x="155.694" y="-43.133" xlink:href="#i"></use><use x="163.841" y="-43.133" xlink:href="#k"></use></g><path d="M-18.234 98.797a7.442 7.442 0 0 0-7.442-7.442 7.444 7.444 0 1 0 7.441 7.441Z"></path><path d="M-18.234 98.797a7.442 7.442 0 0 0-7.442-7.442 7.444 7.444 0 1 0 7.441 7.441Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="-25.677" y="98.798" xlink:href="#b" transform="translate(-21.322 34.06)"></use><path d="M.695 132.86a7.443 7.443 0 1 0-14.887 0 7.442 7.442 0 0 0 7.442 7.44 7.445 7.445 0 0 0 7.445-7.44Z" fill="red"></path><path d="M.695 132.86a7.443 7.443 0 1 0-14.887 0 7.442 7.442 0 0 0 7.442 7.44 7.445 7.445 0 0 0 7.445-7.44Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="-25.677" y="98.798" xlink:href="#c" transform="translate(.186 71.484)"></use><path d="M17.734 167.793a8.316 8.316 0 0 0-8.316-8.317c-4.594 0-8.316 3.723-8.316 8.317s3.722 8.316 8.316 8.316a8.315 8.315 0 0 0 8.316-8.316Z" fill="red"></path><path d="M17.734 167.793a8.316 8.316 0 0 0-8.316-8.317c-4.594 0-8.316 3.723-8.316 8.317s3.722 8.316 8.316 8.316a8.315 8.315 0 0 0 8.316-8.316Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="-22.467" y="98.798" xlink:href="#a" fill="#fff" transform="translate(27.623 71.484)"></use><use x="-25.677" y="98.798" xlink:href="#d" transform="translate(22.103 104.243)"></use><use x="-25.677" y="98.798" xlink:href="#e" transform="translate(43.3 104.243)"></use><path d="m-29.582 105.367-12.746 21.445" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-42.734 127.5c.68-.754 1.53-1.407 2.742-2.079-1.383.57-2.07.16-2.227-1.324-.011 1.383-.18 2.446-.515 3.403Z"></path><path d="M-42.734 127.5c.68-.754 1.53-1.407 2.742-2.079-1.383.57-2.07.16-2.227-1.324-.011 1.383-.18 2.446-.515 3.403Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-21.965 105.477 11.02 19.832" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-10.559 126.004c-.308-.969-.445-2.031-.418-3.414-.203 1.48-.898 1.867-2.261 1.258 1.191.703 2.023 1.382 2.68 2.156Z"></path><path d="M-10.559 126.004c-.308-.969-.445-2.031-.418-3.414-.203 1.48-.898 1.867-2.261 1.258 1.191.703 2.023 1.382 2.68 2.156Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-10.035 139.758-10.52 22.105" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-20.898 162.582c.609-.813 1.394-1.543 2.539-2.32-1.325.69-2.043.35-2.34-1.114.117 1.379.05 2.45-.2 3.434Z"></path><path d="M-20.898 162.582c.609-.813 1.394-1.543 2.539-2.32-1.325.69-2.043.35-2.34-1.114.117 1.379.05 2.45-.2 3.434Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-3.54 139.793 8.962 19.367" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M5.758 159.883c-.238-.988-.293-2.058-.164-3.437-.313 1.46-1.035 1.797-2.352 1.09 1.137.789 1.918 1.527 2.516 2.347Z"></path><path d="M5.758 159.883c-.238-.988-.293-2.058-.164-3.437-.313 1.46-1.035 1.797-2.352 1.09 1.137.789 1.918 1.527 2.516 2.347Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m6.777 175.887-6.796 20.828" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-.266 197.473c.5-.887 1.188-1.711 2.22-2.63-1.224.856-1.981.61-2.462-.804.293 1.352.363 2.422.242 3.434Z"></path><path d="M-.266 197.473c.5-.887 1.188-1.711 2.22-2.63-1.224.856-1.981.61-2.462-.804.293 1.352.363 2.422.242 3.434Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m12.152 175.856 6.282 18.523" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M18.688 195.132c-.13-1.007-.075-2.078.203-3.433-.465 1.418-1.22 1.676-2.453.832 1.046.906 1.742 1.722 2.25 2.601Z"></path><path d="M18.688 195.132c-.13-1.007-.075-2.078.203-3.433-.465 1.418-1.22 1.676-2.453.832 1.046.906 1.742 1.722 2.25 2.601Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M5.734 97.879h37.524v-13.45H5.734Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g transform="translate(34.73 -4.238)"><use x="-25.677" y="98.798" xlink:href="#f"></use><use x="-18.548" y="98.798" xlink:href="#g"></use><use x="-13.456" y="98.798" xlink:href="#h"></use><use x="-9.383" y="98.798" xlink:href="#i"></use><use x="-1.236" y="98.798" xlink:href="#l"></use></g><path d="M111.684 98.797a7.442 7.442 0 0 0-14.883 0 7.443 7.443 0 0 0 7.441 7.445 7.443 7.443 0 0 0 7.442-7.445Z"></path><path d="M111.684 98.797a7.442 7.442 0 0 0-14.883 0 7.443 7.443 0 0 0 7.441 7.445 7.443 7.443 0 0 0 7.442-7.445Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="104.242" y="98.798" xlink:href="#b" transform="translate(-26.712 34.06)"></use><path d="M136.004 132.86a7.444 7.444 0 1 0-14.887-.004 7.444 7.444 0 0 0 14.887.004Z" fill="red"></path><path d="M136.004 132.86a7.444 7.444 0 1 0-14.887-.004 7.444 7.444 0 0 0 14.887.004Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M120.707 167.793a8.315 8.315 0 0 0-8.317-8.317 8.318 8.318 0 0 0 0 16.633 8.315 8.315 0 0 0 8.317-8.316Z" fill="red"></path><path d="M120.707 167.793a8.315 8.315 0 0 0-8.317-8.317 8.318 8.318 0 0 0 0 16.633 8.315 8.315 0 0 0 8.317-8.316Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="107.453" y="98.798" xlink:href="#a" fill="#fff" transform="translate(.678 71.484)"></use><use x="104.242" y="98.798" xlink:href="#c" transform="translate(-5.202 104.243)"></use><use x="104.242" y="98.798" xlink:href="#d" transform="translate(16.715 104.243)"></use><use x="104.242" y="98.798" xlink:href="#e" transform="translate(37.912 71.484)"></use><path d="m99.605 104.871-16.976 22.23" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M82.144 127.738c.762-.672 1.684-1.223 2.965-1.75-1.437.406-2.074-.078-2.058-1.57-.172 1.37-.461 2.406-.907 3.32Z"></path><path d="M82.144 127.738c.762-.672 1.684-1.223 2.965-1.75-1.437.406-2.074-.078-2.058-1.57-.172 1.37-.461 2.406-.907 3.32Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m108.684 105.016 14.855 20.812" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M124.004 126.477c-.418-.926-.672-1.969-.797-3.348-.035 1.496-.683 1.957-2.11 1.504 1.263.57 2.165 1.148 2.907 1.844Z"></path><path d="M124.004 126.477c-.418-.926-.672-1.969-.797-3.348-.035 1.496-.683 1.957-2.11 1.504 1.263.57 2.165 1.148 2.907 1.844Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m125.352 139.793-8.965 19.367" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M116.05 159.883c.602-.82 1.383-1.558 2.516-2.347-1.316.707-2.039.37-2.351-1.09.132 1.379.074 2.449-.164 3.437Z"></path><path d="M116.05 159.883c.602-.82 1.383-1.558 2.516-2.347-1.316.707-2.039.37-2.351-1.09.132 1.379.074 2.449-.164 3.437Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m109.656 175.856-6.277 18.523" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M103.121 195.132c.508-.879 1.207-1.695 2.25-2.601-1.23.844-1.988.586-2.453-.832.277 1.355.336 2.426.203 3.433Z"></path><path d="M103.121 195.132c.508-.879 1.207-1.695 2.25-2.601-1.23.844-1.988.586-2.453-.832.277 1.355.336 2.426.203 3.433Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m115.035 175.887 6.793 20.828" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M122.074 197.473c-.117-1.012-.047-2.082.246-3.434-.484 1.414-1.242 1.66-2.464.805 1.035.918 1.722 1.742 2.218 2.629Z"></path><path d="M122.074 197.473c-.117-1.012-.047-2.082.246-3.434-.484 1.414-1.242 1.66-2.464.805 1.035.918 1.722 1.742 2.218 2.629Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m131.844 139.758 10.523 22.105" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M142.707 162.582c-.246-.985-.316-2.055-.2-3.434-.296 1.465-1.015 1.805-2.339 1.113 1.144.778 1.934 1.508 2.539 2.32Z"></path><path d="M142.707 162.582c-.246-.985-.316-2.055-.2-3.434-.296 1.465-1.015 1.805-2.339 1.113 1.144.778 1.934 1.508 2.539 2.32Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M130.262 98.848h37.527V83.46h-37.527Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g transform="translate(29.342 -5.207)"><use x="104.242" y="98.798" xlink:href="#f"></use><use x="111.371" y="98.798" xlink:href="#g"></use><use x="116.463" y="98.798" xlink:href="#h"></use><use x="120.537" y="98.798" xlink:href="#i"></use><use x="128.684" y="98.798" xlink:href="#m"></use></g></svg><figcaption><b>Fig <!-- -->1<!-- -->.</b> <!-- -->Illustration of the four cases of the red-children invariant being broken following insertion. The inserted nodes are marked with a &quot;plus&quot;.</figcaption></figure><p>Such an invariant violation is only a local concern, however. All that is needed in order to restore the invariant is to simple <em>rotate</em> the site of violation, and do a simple recoloring. We will illustrate only the first case, and the rest follow similarly. You may verify for yourself that this continues to preserve the ordering and black-height invariants.</p><figure class="center_wFZg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="338.955" height="206.185" viewBox="-72 -72 254.216 154.639"><defs><path id="l" d="M4.563-6.386c.01-.03.03-.11.03-.13 0-.08-.06-.12-.12-.12s-.07.01-.19.16C3.518-5.45 2.82-5.38 2.532-5.35c-.05.01-.16.02-.16.19 0 .119.12.119.16.119.149 0 .637-.06 1.105-.409L2.461-.727c-.08.319-.16.418-.937.418h-.08c-.169 0-.278 0-.278.19 0 .119.11.119.15.119.427 0 .876-.03 1.304-.03.439 0 .897.03 1.335.03.07 0 .2 0 .2-.19 0-.119-.1-.119-.26-.119h-.08c-.129 0-.298-.01-.428-.02-.219-.03-.279-.04-.279-.18 0-.059.02-.149.03-.188l1.425-5.69Z"></path><path id="h" d="M8.07-6.785c.01-.04.02-.1.02-.139 0-.02-.01-.1-.11-.1-.02 0-.07 0-.16.11l-.627.737c-.428-.687-1.006-.847-1.504-.847-2.053 0-4.195 2.242-4.195 4.583C1.494-.807 2.56.22 3.935.22c1.943 0 3.029-2.132 3.029-2.61 0-.1-.1-.1-.15-.1-.06 0-.13 0-.159.08C6.147-.727 4.902-.09 4.075-.09c-.837 0-1.714-.558-1.714-1.972 0-.618.25-2.182 1.046-3.278.678-.917 1.594-1.375 2.361-1.375 1.056 0 1.415.957 1.415 1.823 0 .26-.05.578-.05.608 0 .1.1.1.15.1.11 0 .14-.01.179-.18l.608-2.42Z"></path><path id="i" d="M3.477-.588c.11.488.478.698.827.698.368 0 .578-.25.727-.558.18-.379.299-.957.299-.977 0-.1-.08-.1-.15-.1-.119 0-.129.01-.189.23-.14.558-.328 1.185-.667 1.185-.26 0-.26-.269-.26-.408 0-.07 0-.23.07-.508l.678-2.71c.04-.14.04-.16.04-.21 0-.208-.17-.258-.27-.258-.318 0-.388.338-.398.388-.189-.428-.508-.587-.827-.587-1.105 0-2.281 1.514-2.281 2.968 0 .847.458 1.545 1.205 1.545.36 0 .797-.21 1.196-.698Zm.538-2.53-.468 1.883C3.467-.917 2.849-.11 2.3-.11c-.468 0-.548-.587-.548-.886 0-.498.31-1.664.489-2.082.249-.608.707-1.106 1.115-1.106.439 0 .688.518.688.936 0 .02-.01.07-.03.13Z"></path><path id="k" d="M2.381-2.301c.299 0 .966-.03 1.445-.22.787-.318.787-.966.787-1.036 0-.458-.369-.846-1.007-.846-1.046 0-2.47 1.006-2.47 2.77C1.136-.738 1.614.11 2.56.11c1.276 0 2.103-.997 2.103-1.146 0-.05-.08-.16-.16-.16-.04 0-.05.01-.13.11-.737.937-1.623.976-1.793.976-.647 0-.757-.707-.757-1.095 0-.38.1-.827.17-1.096h.388Zm-.329-.22c.429-1.633 1.455-1.663 1.554-1.663.399 0 .628.269.628.607 0 1.056-1.644 1.056-1.972 1.056h-.21Z"></path><path id="j" d="M2.46-1.963c.44.1.887.2.887.738 0 .318-.269 1.115-1.295 1.115-.219 0-.797-.05-.956-.557.508-.05.508-.469.508-.489 0-.189-.13-.318-.339-.318-.229 0-.508.169-.508.617 0 .608.578.967 1.285.967 1.495 0 1.873-1.216 1.873-1.674 0-.867-.777-1.046-1.185-1.136-.28-.06-.638-.14-.638-.568 0-.239.21-.916 1.006-.916.27 0 .638.1.748.488a.436.436 0 0 0-.399.408c0 .11.06.28.299.28.17 0 .428-.12.428-.549 0-.458-.408-.846-1.066-.846A1.512 1.512 0 0 0 1.534-2.93c0 .767.648.907.927.966Z"></path><path id="d" d="M3.975-2.88c0-1.015-.727-1.713-1.644-1.713-.647 0-1.096.16-1.564.429l.06.657c.518-.368 1.016-.498 1.504-.498.469 0 .867.399.867 1.136v.428c-1.494.02-2.76.439-2.76 1.315C.438-.697.708.11 1.574.11c.14 0 1.076-.02 1.654-.469V0h.747v-2.88Zm-.777 1.565c0 .19 0 .438-.339.628-.289.179-.667.189-.777.189-.478 0-.926-.23-.926-.648 0-.697 1.614-.767 2.042-.787v.618Z"></path><path id="e" d="M1.564-6.914H.817V0h.777v-.458c.24.219.668.568 1.335.568.996 0 1.853-.997 1.853-2.332 0-1.235-.677-2.311-1.614-2.311-.388 0-1.006.1-1.604.588v-2.97Zm.03 3.577c.16-.24.518-.588 1.066-.588.588 0 1.345.428 1.345 1.703 0 1.295-.837 1.724-1.445 1.724-.388 0-.717-.18-.966-.638v-2.201Z"></path><path id="f" d="M4.085-4.164c-.588-.34-.927-.429-1.535-.429C1.166-4.593.36-3.387.36-2.212.359-.976 1.265.11 2.51.11c.538 0 1.086-.14 1.623-.509l-.06-.667a2.457 2.457 0 0 1-1.553.538c-.827 0-1.385-.717-1.385-1.694 0-.777.368-1.733 1.424-1.733.518 0 .857.08 1.405.438l.12-.647Z"></path><path id="g" d="M4.324-6.914h-.747v2.929a2.295 2.295 0 0 0-1.455-.548c-.986 0-1.763 1.036-1.763 2.321C.359-.907 1.126.11 2.072.11c.329 0 .917-.09 1.475-.628V0h.777v-6.914Zm-.777 5.53c0 .139-.01.318-.33.607-.228.2-.477.279-.736.279-.618 0-1.345-.468-1.345-1.704 0-1.315.857-1.723 1.444-1.723.449 0 .748.229.967.548v1.992Z"></path><path id="n" d="M6.565-2.291c.17 0 .35 0 .35-.2s-.18-.199-.35-.199h-5.39c-.169 0-.348 0-.348.2s.18.199.349.199h5.39Z"></path><path id="o" d="M8.309-2.291c-.548.418-.817.826-.897.956-.448.687-.528 1.315-.528 1.325 0 .12.12.12.2.12.169 0 .179-.02.219-.2.229-.976.817-1.813 1.942-2.271.12-.04.15-.06.15-.13s-.06-.1-.08-.11c-.438-.169-1.644-.667-2.022-2.34-.03-.12-.04-.15-.21-.15-.08 0-.199 0-.199.12 0 .02.09.647.508 1.315.2.299.488.647.917.966H.907c-.18 0-.36 0-.36.2s.18.199.36.199h7.402Z"></path><path id="m" d="M.946-2.291c.06 0 .28 0 .28-.2s-.22-.199-.28-.199v-1.305c0-.16 0-.349-.199-.349s-.2.19-.2.349v3.009c0 .16 0 .348.2.348s.2-.189.2-.348v-1.305Z"></path><path id="c" d="M3.537-6.655c0-.19 0-.478-.439-.478-.199 0-.239.02-.358.14-.18.159-.558.527-1.544.547-.18 0-.439.07-.439.359 0 .358.349.358.478.358.3 0 .648-.05.937-.129v5.14h-.777c-.13 0-.478 0-.478.36S1.265 0 1.395 0h2.84c.109 0 .477 0 .477-.359s-.368-.358-.478-.358h-.697v-5.938Z"></path><path id="b" d="M.648-.847c-.1.1-.1.12-.1.29v.079c0 .358.11.478.478.478h3.417c.379 0 .479-.13.479-.478v-.12c0-.16 0-.348-.21-.438-.07-.04-.388-.04-.587-.04-.22 0-.459.01-.678.01H1.833l1.315-1.245c.15-.13.528-.439.678-.578.548-.538 1.096-1.066 1.096-1.953 0-1.215-.877-2.291-2.342-2.291-.348 0-.916.05-1.394.438-.09.07-.548.428-.728 1.096l.498.638c.06.08.09.12.16.12.09 0 .11-.07.14-.19.199-.688.537-1.106 1.175-1.106.777 0 1.096.707 1.096 1.315 0 .638-.379 1.305-.977 1.943L.648-.847Z"></path><path id="a" d="M.956-5.53c.08.12.13.12.15.12.07 0 .09-.04.14-.11.507-.727 1.215-.727 1.344-.727.638 0 .728.33.728.817 0 .14 0 .618-.31.997-.238.279-.487.299-.786.318-.11.01-.3.02-.33.04-.069.03-.069.09-.069.25v.179c0 .259.01.269.27.269h.438c.906 0 1.016.568 1.016 1.335 0 .667-.07 1.325-.977 1.325-.318 0-1.056-.07-1.723-.698-.09-.09-.1-.1-.14-.1-.1 0-.12.09-.13.11 0 .01-.119.638-.119.688 0 .13.857.936 2.162.936 1.714 0 2.391-.916 2.391-2.241 0-.897-.478-1.505-1.375-1.734.807-.438 1.076-1.086 1.076-1.654 0-1.594-1.424-1.723-2.072-1.723-1.365 0-2.032.976-2.032 1.056 0 .06.06.14.07.15l.278.398Z"></path></defs><path fill="#fff" d="M-72-72h254.216V82.639H-72z"></path><path d="M34.469-42.496a8.21 8.21 0 1 0-16.42.005 8.21 8.21 0 0 0 16.42-.005Z"></path><path d="M34.469-42.496a8.21 8.21 0 1 0-16.42.005 8.21 8.21 0 0 0 16.42-.005Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="30.991" y="-39.035" xlink:href="#a" fill="#fff" transform="translate(-7.472)"></use><path d="M15.586-6.902a8.206 8.206 0 0 0-8.207-8.207 8.21 8.21 0 1 0 8.207 8.207Z" fill="red"></path><path d="M15.586-6.902a8.206 8.206 0 0 0-8.207-8.207 8.21 8.21 0 1 0 8.207 8.207Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="30.991" y="-39.035" xlink:href="#b" fill="#fff" transform="translate(-26.353 35.594)"></use><path d="M-.613 28.691a8.21 8.21 0 1 0-16.42.006 8.21 8.21 0 0 0 16.42-.006Z" fill="red"></path><path d="M-.613 28.691a8.21 8.21 0 1 0-16.42.006 8.21 8.21 0 0 0 16.42-.006Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="30.991" y="-39.035" xlink:href="#c" fill="#fff" transform="translate(-42.554 71.187)"></use><use x="26.259" y="-39.035" xlink:href="#d" transform="translate(-48.318 102.87)"></use><use x="26.259" y="-39.035" xlink:href="#e" transform="translate(-26.813 102.87)"></use><use x="26.259" y="-39.035" xlink:href="#f" transform="translate(-4.894 71.187)"></use><use x="26.259" y="-39.035" xlink:href="#g" transform="translate(16.307 35.594)"></use><path d="M22.32-35.066 11.785-15.211" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M11.41-14.504c.645-.789 1.465-1.48 2.64-2.21-1.35.636-2.058.26-2.288-1.216.054 1.383-.059 2.45-.352 3.426Z"></path><path d="M11.41-14.504c.645-.789 1.465-1.48 2.64-2.21-1.35.636-2.058.26-2.288-1.216.054 1.383-.059 2.45-.352 3.426Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m3.894.754-8.82 19.379" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-5.258 20.86c.594-.825 1.371-1.567 2.5-2.368-1.312.719-2.035.387-2.36-1.07.141 1.375.09 2.445-.14 3.437Z"></path><path d="M-5.258 20.86c.594-.825 1.371-1.567 2.5-2.368-1.312.719-2.035.387-2.36-1.07.141 1.375.09 2.445-.14 3.437Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m-11.453 36.68-6.82 20.71" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M-18.523 58.145c.504-.883 1.191-1.704 2.23-2.622-1.226.856-1.984.606-2.46-.808.288 1.351.355 2.422.23 3.43Z"></path><path d="M-18.523 58.145c.504-.883 1.191-1.704 2.23-2.622-1.226.856-1.984.606-2.46-.808.288 1.351.355 2.422.23 3.43Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M-6.102 36.648.242 55.176" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M.5 55.93c-.137-1.004-.082-2.078.191-3.434-.46 1.422-1.214 1.68-2.449.84C-.71 54.238-.012 55.055.5 55.93Z"></path><path d="M.5 55.93c-.137-1.004-.082-2.078.191-3.434-.46 1.422-1.214 1.68-2.449.84C-.71 54.238-.012 55.055.5 55.93Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m10.762.797 11.074 25.18" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M22.16 26.707c-.219-.992-.258-2.062-.101-3.437-.336 1.453-1.067 1.773-2.368 1.039 1.118.816 1.883 1.566 2.47 2.398Z"></path><path d="M22.16 26.707c-.219-.992-.258-2.062-.101-3.437-.336 1.453-1.067 1.773-2.368 1.039 1.118.816 1.883 1.566 2.47 2.398Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m30.2-35.066 12.366 23.312" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M42.938-11.05c-.29-.973-.407-2.04-.348-3.423-.235 1.477-.938 1.848-2.29 1.211 1.177.73 1.997 1.426 2.638 2.211Z"></path><path d="M42.938-11.05c-.29-.973-.407-2.04-.348-3.423-.235 1.477-.938 1.848-2.29 1.211 1.177.73 1.997 1.426 2.638 2.211Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M-41.688-44.18h37.524v-13.449h-37.523Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g transform="translate(-64.626 -8.464)"><use x="26.259" y="-39.035" xlink:href="#h"></use><use x="33.387" y="-39.035" xlink:href="#i"></use><use x="38.479" y="-39.035" xlink:href="#j"></use><use x="42.553" y="-39.035" xlink:href="#k"></use><use x="50.7" y="-39.035" xlink:href="#l"></use></g><use x="55.108" y="7.71" xlink:href="#m"></use><use x="55.108" y="7.71" xlink:href="#n"></use><use x="61.196" y="7.71" xlink:href="#o"></use><path d="M120.926-28.16a8.21 8.21 0 1 0-16.418 0 8.21 8.21 0 1 0 16.418 0Z" fill="red"></path><path d="M120.926-28.16a8.21 8.21 0 1 0-16.418 0 8.21 8.21 0 1 0 16.418 0Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="117.449" y="-24.7" xlink:href="#a" fill="#fff" transform="translate(-7.472)"></use><path d="M99.336 7.434a8.207 8.207 0 0 0-8.207-8.211 8.21 8.21 0 0 0-8.211 8.21 8.21 8.21 0 0 0 8.21 8.212 8.207 8.207 0 0 0 8.208-8.211Z"></path><path d="M99.336 7.434a8.207 8.207 0 0 0-8.207-8.211 8.21 8.21 0 0 0-8.211 8.21 8.21 8.21 0 0 0 8.21 8.212 8.207 8.207 0 0 0 8.208-8.211Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="117.449" y="-24.7" xlink:href="#c" fill="#fff" transform="translate(-29.061 35.594)"></use><use x="112.717" y="-24.7" xlink:href="#d" transform="translate(-34.826 67.276)"></use><use x="112.717" y="-24.7" xlink:href="#e" transform="translate(-13.32 67.276)"></use><path d="M142.516 7.434a8.21 8.21 0 1 0-16.418 0 8.21 8.21 0 1 0 16.418 0Z"></path><path d="M142.516 7.434a8.21 8.21 0 1 0-16.418 0 8.21 8.21 0 1 0 16.418 0Z" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><use x="117.449" y="-24.7" xlink:href="#b" fill="#fff" transform="translate(14.117 35.594)"></use><use x="112.717" y="-24.7" xlink:href="#f" transform="translate(8.596 67.276)"></use><use x="112.717" y="-24.7" xlink:href="#g" transform="translate(29.794 67.276)"></use><path d="M108.355-20.969 96.004-.605" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M95.594.074c.683-.75 1.543-1.394 2.758-2.054-1.387.558-2.067.144-2.215-1.344-.024 1.383-.2 2.441-.543 3.398Z"></path><path d="M95.594.074c.683-.75 1.543-1.394 2.758-2.054-1.387.558-2.067.144-2.215-1.344-.024 1.383-.2 2.441-.543 3.398Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m88.5 15.422-6.82 20.707" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M81.43 36.887c.5-.883 1.191-1.703 2.226-2.621-1.226.855-1.98.605-2.46-.813.288 1.356.355 2.426.234 3.434Z"></path><path d="M81.43 36.887c.5-.883 1.191-1.703 2.226-2.621-1.226.855-1.98.605-2.46-.813.288 1.356.355 2.426.234 3.434Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m93.852 15.39 6.34 18.528" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M100.45 34.672c-.134-1.008-.079-2.078.195-3.434-.461 1.422-1.215 1.68-2.454.836 1.047.906 1.747 1.719 2.258 2.598Z"></path><path d="M100.45 34.672c-.134-1.008-.079-2.078.195-3.434-.461 1.422-1.215 1.68-2.454.836 1.047.906 1.747 1.719 2.258 2.598Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="M117.078-20.969 129.43-.605" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M129.844.074c-.348-.957-.523-2.015-.547-3.398-.148 1.488-.828 1.902-2.215 1.344 1.215.66 2.075 1.304 2.762 2.054Z"></path><path d="M129.844.074c-.348-.957-.523-2.015-.547-3.398-.148 1.488-.828 1.902-2.215 1.344 1.215.66 2.075 1.304 2.762 2.054Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m131.691 15.426-6.816 20.824" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M124.625 37.008c.5-.887 1.187-1.707 2.222-2.63-1.222.86-1.98.61-2.46-.804.289 1.356.359 2.426.238 3.434Z"></path><path d="M124.625 37.008c.5-.887 1.187-1.707 2.222-2.63-1.222.86-1.98.61-2.46-.804.289 1.356.359 2.426.238 3.434Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path><path d="m137.016 15.395 6.3 18.52" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M143.57 34.668c-.129-1.004-.074-2.078.2-3.434-.461 1.422-1.215 1.676-2.45.836 1.043.907 1.742 1.72 2.25 2.598Z"></path><path d="M143.57 34.668c-.129-1.004-.074-2.078.2-3.434-.461 1.422-1.215 1.676-2.45.836 1.043.907 1.742 1.72 2.25 2.598Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path></svg><figcaption><b>Fig <!-- -->2<!-- -->.</b> <!-- -->Illustration of the &quot;balancing&quot; necessary in order to preserve the red-children invariant in Case 1 of Fig. 1.</figcaption></figure><p>We thus write the following function which takes care of all four cases.</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance T </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> T</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that if we are not in any of the four described cases, <code>balance</code> simply acts as the identity function, as there is no invariant being broken.</p><p>However, this rotation may itself cause another site of red-children invariant violation, slightly farther up. As such, we must <em>propagate</em> this balancing operation as far up as necessary, in order to produce a proper binary tree at the very end. To this end, we can write the following code for the inductive case of <code>insert</code>:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> insert </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">insert L </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert R </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This code ensures that, after descending into a subtree in order to insert the given key and value, a balancing operation is immediately performed once the insertion is complete. This ensures that we have a <em>bottom-up</em> propagation of balancings, immediately after completing the insertions. Note that because <code>balance</code> acts as the identity function on anything that does not pattern-match to either of the four cases, we perform only a negligible amount of extra checks at each recursive call, and ultimately are only concerned with those four cases.</p><p>However, this code is not complete. There is a minor edge case that remains - what if we are too close to the root for any of the four cases to apply? Our previous analysis relied on the fact that we could assume that the parent of our inserted node was red, and thus had a black parent - what of the case where the parent of the inserted node <em>has no</em> parent?</p><p>Consider the case illustrated below:</p><figure class="center_wFZg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="289.741" height="109.481" viewBox="-72 -72 217.306 82.111"><defs><path id="r" d="M.324-.423c-.05.05-.05.06-.05.144v.04c0 .18.055.239.24.239h1.708c.189 0 .239-.065.239-.24v-.059c0-.08 0-.174-.105-.22-.035-.019-.194-.019-.294-.019-.11 0-.229.005-.338.005H.917l.657-.623c.075-.064.264-.219.339-.289.274-.269.548-.533.548-.976 0-.608-.439-1.146-1.17-1.146-.175 0-.46.025-.698.22a1.046 1.046 0 0 0-.364.547l.25.32c.03.04.044.06.079.06.045 0 .055-.036.07-.096.1-.343.269-.552.587-.552.389 0 .548.353.548.657 0 .319-.189.653-.488.971L.324-.423Z"></path><path id="v" d="M.478-2.765c.04.06.065.06.075.06.035 0 .045-.02.07-.055.254-.363.607-.363.672-.363.319 0 .364.164.364.408 0 .07 0 .309-.155.498-.12.14-.244.15-.393.16-.055.005-.15.01-.165.02-.034.015-.034.044-.034.124v.09c0 .13.005.134.134.134h.22c.453 0 .507.284.507.668 0 .334-.035.662-.488.662a1.26 1.26 0 0 1-.862-.348c-.044-.045-.05-.05-.07-.05-.05 0-.06.045-.064.055 0 .005-.06.318-.06.343C.23-.294.658.11 1.31.11c.857 0 1.196-.459 1.196-1.121 0-.449-.24-.752-.688-.867.404-.22.538-.543.538-.827 0-.797-.712-.862-1.036-.862-.682 0-1.016.489-1.016.528 0 .03.03.07.035.075l.14.2Z"></path><path id="q" d="M1.086-2.147c0-.13-.005-.134-.135-.134H.568c-.13 0-.135.005-.135.134v.384c0 .13.005.134.135.134H.95c.13 0 .135-.005.135-.134v-.384ZM.433-.134c0 .129.005.134.135.134H.95c.13 0 .135-.005.135-.134v-.384c0-.13-.005-.135-.135-.135H.568c-.13 0-.135.005-.135.135v.384Z"></path><path id="p" d="M2.311-1.574c0-.787-.757-.792-1.006-.792-.234 0-.483.02-.817.16-.104.044-.13.06-.13.114 0 .035.03.324.036.363.005.03.03.055.064.055.025 0 .04-.015.055-.03.214-.224.463-.333.772-.333.27 0 .349.164.349.458v.174c-.174 0-1.48.01-1.48.742a.72.72 0 0 0 .718.718c.17 0 .543-.05.777-.394v.1c0 .16.035.239.239.239h.184c.19 0 .24-.065.24-.24v-1.334Zm-.677.807c0 .463-.473.463-.488.463-.21 0-.344-.18-.344-.368 0-.489.692-.524.832-.528v.433Z"></path><path id="u" d="M.966-3.218c0-.16-.034-.239-.239-.239H.543c-.18 0-.24.055-.24.24V-.24c0 .18.056.239.24.239h.2C.826 0 .975 0 .98-.194c.23.249.484.249.563.249 1.061 0 1.061-.957 1.061-1.206 0-.239 0-1.185-.936-1.185a.99.99 0 0 0-.703.279v-1.16Zm.015 1.415a.65.65 0 0 1 .444-.175c.503 0 .503.459.503.832 0 .369 0 .842-.558.842A.489.489 0 0 1 .98-.498v-1.305Z"></path><path id="n" d="M6.416-1.576c-.879.642-.997 1.555-.997 1.562 0 .105.07.105.167.105.126 0 .147 0 .181-.119a2.17 2.17 0 0 1 .516-1.004c.405-.426.754-.53 1.047-.62a.103.103 0 0 0 .07-.091c0-.07-.043-.084-.133-.112-1.004-.32-1.36-1.032-1.507-1.646-.027-.084-.076-.084-.174-.084s-.167 0-.167.105c0 .014.07.481.411.962.16.238.356.433.586.6h-5.6c-.112 0-.279 0-.279.168 0 .174.16.174.279.174h5.6Z"></path><path id="m" d="M.879-1.576c.216 0 .216-.154.216-.167 0-.077-.042-.175-.216-.175v-.892c0-.098 0-.272-.168-.272-.174 0-.174.167-.174.272v2.127c0 .104 0 .272.174.272.168 0 .168-.175.168-.272v-.893Z"></path><path id="l" d="M2.943-2.664c-.146-.23-.384-.411-.718-.411-.893 0-1.8.983-1.8 1.987C.425-.41.88.07 1.478.07c.377 0 .712-.216.99-.488.133.418.538.488.719.488.251 0 .425-.154.551-.37.153-.272.244-.67.244-.697 0-.09-.09-.09-.112-.09-.097 0-.104.027-.153.215-.084.335-.216.746-.509.746-.181 0-.23-.153-.23-.341 0-.119.056-.37.104-.551.05-.188.119-.474.154-.628l.14-.53c.041-.181.125-.509.125-.544 0-.153-.126-.223-.237-.223a.338.338 0 0 0-.321.279ZM2.497-.872c-.05.196-.203.335-.356.468-.063.055-.342.278-.642.278-.258 0-.509-.18-.509-.676 0-.37.203-1.137.363-1.416.32-.558.676-.662.872-.662.488 0 .62.53.62.607a.402.402 0 0 1-.02.097L2.496-.872Z"></path><path id="s" d="M1.841-4.63a.867.867 0 0 0 .028-.112c0-.035-.028-.098-.112-.098-.14 0-.718.056-.892.07-.056.007-.154.014-.154.16 0 .098.098.098.182.098.334 0 .334.049.334.105 0 .048-.07.327-.111.488l-.16.641C.892-3.04.508-1.513.495-1.423.46-1.255.46-1.165.46-1.08.46-.377.907.07 1.485.07c.872 0 1.8-.948 1.8-1.98 0-.816-.565-1.164-1.046-1.164-.363 0-.67.202-.88.383l.482-1.939ZM1.492-.127c-.341 0-.537-.3-.537-.71 0-.259.063-.496.258-1.284.042-.133.042-.147.175-.3.265-.307.579-.46.83-.46.272 0 .509.202.509.676 0 .286-.154.998-.363 1.402-.167.342-.516.676-.872.676Z"></path><path id="j" d="M6.565-2.291c.17 0 .35 0 .35-.2s-.18-.199-.35-.199h-5.39c-.169 0-.348 0-.348.2s.18.199.349.199h5.39Z"></path><path id="k" d="M8.309-2.291c-.548.418-.817.826-.897.956-.448.687-.528 1.315-.528 1.325 0 .12.12.12.2.12.169 0 .179-.02.219-.2.229-.976.817-1.813 1.942-2.271.12-.04.15-.06.15-.13s-.06-.1-.08-.11c-.438-.169-1.644-.667-2.022-2.34-.03-.12-.04-.15-.21-.15-.08 0-.199 0-.199.12 0 .02.09.647.508 1.315.2.299.488.647.917.966H.907c-.18 0-.36 0-.36.2s.18.199.36.199h7.402Z"></path><path id="i" d="M1.527-.398a.399.399 0 0 0-.397-.404.399.399 0 0 0-.405.398c0 .244.196.404.398.404a.399.399 0 0 0 .404-.398Z"></path><path id="o" d="M3.522-1.27h-.237c-.021.154-.091.566-.182.635-.055.042-.592.042-.69.042H1.13c.732-.648.976-.844 1.395-1.171.516-.412.997-.844.997-1.507 0-.844-.74-1.36-1.632-1.36-.865 0-1.45.607-1.45 1.249 0 .355.3.39.369.39.167 0 .37-.118.37-.37 0-.125-.05-.369-.412-.369.216-.495.69-.649 1.018-.649.698 0 1.06.544 1.06 1.11 0 .606-.432 1.087-.655 1.338L.51-.272C.44-.209.44-.195.44 0h2.873l.209-1.27Z"></path><path id="t" d="M1.904-2.33c.544 0 .934.377.934 1.124 0 .864-.502 1.122-.906 1.122-.28 0-.893-.076-1.186-.488.328-.014.405-.244.405-.39a.374.374 0 0 0-.384-.384c-.195 0-.39.119-.39.405 0 .655.725 1.08 1.569 1.08.97 0 1.639-.648 1.639-1.345 0-.544-.447-1.088-1.214-1.249.732-.265.997-.788.997-1.213 0-.551-.634-.963-1.408-.963s-1.367.377-1.367.935c0 .237.153.37.362.37.217 0 .356-.16.356-.356 0-.202-.14-.349-.356-.363.245-.307.726-.383.984-.383.314 0 .753.153.753.76 0 .293-.098.613-.279.83-.23.265-.425.279-.774.3-.174.013-.188.013-.223.02-.014 0-.07.014-.07.091 0 .098.063.098.181.098h.377Z"></path><path id="f" d="M1.471-4.303a.403.403 0 0 0-.404-.397.397.397 0 0 0-.398.397c0 .251.203.405.398.405a.4.4 0 0 0 .404-.405ZM.411-2.999v.251c.44 0 .503.042.503.384v1.813c0 .3-.07.3-.523.3V0c.013 0 .502-.028.78-.028.245 0 .496.007.74.028v-.251c-.405 0-.474 0-.474-.293v-2.531L.41-3Z"></path><path id="g" d="M3.592-2.113c0-.607-.3-.962-1.047-.962-.571 0-.941.313-1.136.676h-.007v-.676L.377-3v.251c.467 0 .523.05.523.39V-.55c0 .3-.07.3-.523.3V0c.014 0 .502-.028.795-.028.258 0 .739.021.802.028v-.251c-.454 0-.523 0-.523-.3v-1.255c0-.732.578-1.074 1.039-1.074.488 0 .55.383.55.739v1.59c0 .3-.07.3-.522.3V0c.014 0 .502-.028.795-.028.258 0 .739.021.802.028v-.251c-.454 0-.523 0-.523-.3v-1.562Z"></path><path id="h" d="M2.643-2.929c0-.119 0-.181-.098-.181-.034 0-.048 0-.139.083-.014.007-.084.07-.126.105-.209-.146-.474-.188-.732-.188-.997 0-1.234.523-1.234.871 0 .224.097.405.265.544.265.23.53.28.962.349.349.063.914.16.914.628 0 .272-.188.592-.858.592S.683-.565.557-1.039c-.02-.09-.027-.119-.125-.119-.118 0-.118.05-.118.189v.857c0 .119 0 .182.097.182.063 0 .196-.147.335-.3.307.286.684.3.851.3.907 0 1.241-.488 1.241-.984a.852.852 0 0 0-.3-.641c-.265-.244-.585-.3-.83-.342-.557-.098-1.01-.181-1.01-.55 0-.224.188-.496.85-.496.81 0 .844.565.858.767.007.077.09.077.119.077.118 0 .118-.049.118-.181v-.649Z"></path><path id="a" d="M1.355-.777c0 .359-.02.468-.787.468h-.24V0h5.75l.418-2.57h-.25C5.999-1.036 5.769-.31 4.056-.31H2.73c-.468 0-.488-.07-.488-.398v-2.66h.896c.967 0 1.076.318 1.076 1.165h.25v-2.64h-.25c0 .857-.11 1.166-1.076 1.166h-.896v-2.391c0-.329.02-.399.488-.399h1.285c1.524 0 1.793.548 1.953 1.933h.249l-.28-2.242H.33v.31h.239c.767 0 .787.109.787.467v5.22Z"></path><path id="b" d="M1.096-3.427v2.67c0 .448-.11.448-.777.448V0c.348-.01.857-.03 1.126-.03.259 0 .777.02 1.115.03v-.309c-.667 0-.777 0-.777-.448V-2.59c0-1.036.708-1.594 1.345-1.594.628 0 .738.538.738 1.106v2.32c0 .45-.11.45-.778.45V0c.35-.01.857-.03 1.126-.03.26 0 .777.02 1.116.03v-.309c-.667 0-.777 0-.777-.448V-2.59c0-1.036.707-1.594 1.345-1.594.628 0 .737.538.737 1.106v2.32c0 .45-.11.45-.777.45V0c.349-.01.857-.03 1.126-.03.259 0 .777.02 1.116.03v-.309c-.518 0-.767 0-.777-.299V-2.51c0-.856 0-1.165-.31-1.524-.139-.17-.468-.368-1.045-.368-.837 0-1.276.597-1.445.976-.14-.867-.877-.976-1.325-.976-.727 0-1.196.428-1.474 1.046v-1.046l-1.405.11v.308c.697 0 .777.07.777.558Z"></path><path id="c" d="M1.714-3.746v-.657l-1.435.11v.308c.707 0 .777.06.777.498v4.663c0 .448-.11.448-.777.448v.309c.339-.01.857-.03 1.116-.03.269 0 .777.02 1.126.03v-.31c-.668 0-.778 0-.778-.447V-.588c.05.16.469.698 1.226.698C4.154.11 5.19-.867 5.19-2.152c0-1.265-.967-2.251-2.083-2.251-.777 0-1.195.438-1.394.657Zm.03 2.61v-2.221c.288-.509.777-.797 1.285-.797.727 0 1.335.876 1.335 2.002 0 1.206-.698 2.042-1.435 2.042-.398 0-.777-.199-1.046-.607-.14-.21-.14-.22-.14-.419Z"></path><path id="d" d="M1.724-3.985h1.424v-.309H1.724v-1.833h-.25c-.01.817-.308 1.883-1.285 1.923v.219h.847v2.75C1.036-.01 1.963.11 2.321.11c.708 0 .987-.708.987-1.345v-.568h-.25v.548c0 .737-.298 1.116-.667 1.116-.667 0-.667-.907-.667-1.076v-2.77Z"></path><path id="e" d="M4.134-3.347c.26-.628.768-.638.927-.638v-.309c-.23.02-.518.03-.747.03-.18 0-.648-.02-.867-.03v.309c.309.01.468.18.468.428 0 .1-.01.12-.06.24L2.85-.868l-1.106-2.68c-.04-.1-.06-.14-.06-.179 0-.26.37-.26.559-.26v-.308c-.26.01-.917.03-1.086.03-.27 0-.668-.01-.967-.03v.309c.478 0 .668 0 .807.349L2.491 0c-.05.13-.19.458-.25.588-.219.548-.498 1.235-1.135 1.235-.05 0-.28 0-.468-.18.308-.039.388-.258.388-.418A.403.403 0 0 0 .608.807c-.2 0-.419.13-.419.428 0 .449.419.807.917.807.627 0 1.036-.568 1.275-1.135l1.753-4.254Z"></path></defs><path fill="#fff" d="M-72-72h217.306v82.111H-72z"></path><use x="-41.887" y="-28.554" xlink:href="#a"></use><use x="-35.106" y="-28.554" xlink:href="#b"></use><use x="-26.804" y="-28.554" xlink:href="#c"></use><use x="-21.269" y="-28.554" xlink:href="#d"></use><use x="-17.672" y="-28.554" xlink:href="#e"></use><use x="-1.315" y="-32.718" xlink:href="#f"></use><use x="0.94" y="-32.718" xlink:href="#g"></use><use x="5.341" y="-32.718" xlink:href="#h"></use><use x="8.497" y="-32.718" xlink:href="#i"></use><use x="-7.254" y="-27.071" xlink:href="#j"></use><use x="-2.35" y="-27.071" xlink:href="#j"></use><use x="3.185" y="-27.071" xlink:href="#j"></use><use x="8.089" y="-27.071" xlink:href="#k"></use><use x="-4.76" y="-20.916" xlink:href="#l"></use><use x="0.922" y="-20.916" xlink:href="#m"></use><use x="0.922" y="-20.916" xlink:href="#n"></use><use x="10.226" y="-20.916" xlink:href="#o"></use><path d="M40.129-32.738a7.652 7.652 0 0 0-7.652-7.653c-4.227 0-7.653 3.426-7.653 7.653s3.426 7.652 7.653 7.652a7.652 7.652 0 0 0 7.652-7.652Z" fill="red"></path><path d="M40.129-32.738a7.652 7.652 0 0 0-7.652-7.653c-4.227 0-7.653 3.426-7.653 7.653s3.426 7.652 7.653 7.652a7.652 7.652 0 0 0 7.652-7.652Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g fill="#fff" transform="translate(-7.472)"><use x="35.597" y="-31.008" xlink:href="#p"></use><use x="39.125" y="-31.008" xlink:href="#q"></use><use x="41.561" y="-31.008" xlink:href="#r"></use></g><use x="56.285" y="-32.718" xlink:href="#f"></use><use x="58.54" y="-32.718" xlink:href="#g"></use><use x="62.94" y="-32.718" xlink:href="#h"></use><use x="66.097" y="-32.718" xlink:href="#i"></use><use x="50.755" y="-27.071" xlink:href="#j"></use><use x="55.25" y="-27.071" xlink:href="#j"></use><use x="60.785" y="-27.071" xlink:href="#j"></use><use x="65.28" y="-27.071" xlink:href="#k"></use><use x="53.249" y="-20.567" xlink:href="#s"></use><use x="58.113" y="-20.567" xlink:href="#m"></use><use x="58.113" y="-20.567" xlink:href="#n"></use><use x="67.416" y="-20.567" xlink:href="#t"></use><path d="M98.137-49.977a7.651 7.651 0 1 0-15.3 0 7.651 7.651 0 1 0 15.3 0Z" fill="red"></path><path d="M98.137-49.977a7.651 7.651 0 1 0-15.3 0 7.651 7.651 0 1 0 15.3 0Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g fill="#fff" transform="translate(-7.472)"><use x="93.606" y="-48.247" xlink:href="#p"></use><use x="97.134" y="-48.247" xlink:href="#q"></use><use x="99.57" y="-48.247" xlink:href="#r"></use></g><path d="M109.277-15.5a7.652 7.652 0 0 0-7.652-7.652c-4.227 0-7.653 3.425-7.653 7.652s3.426 7.652 7.653 7.652a7.652 7.652 0 0 0 7.652-7.652Z" fill="red"></path><path d="M109.277-15.5a7.652 7.652 0 0 0-7.652-7.652c-4.227 0-7.653 3.425-7.653 7.652s3.426 7.652 7.653 7.652a7.652 7.652 0 0 0 7.652-7.652Z" stroke="red" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><g fill="#fff" transform="translate(3.666 34.477)"><use x="93.516" y="-48.247" xlink:href="#u"></use><use x="97.224" y="-48.247" xlink:href="#q"></use><use x="99.66" y="-48.247" xlink:href="#v"></use></g><path d="m92.898-42.508 6.008 18.59" stroke="#000" fill="none" stroke-width="0.399" stroke-miterlimit="10"></path><path d="M99.148-23.16c-.117-1.008-.043-2.078.254-3.43-.484 1.414-1.246 1.656-2.465.797 1.032.922 1.715 1.746 2.211 2.633Z"></path><path d="M99.148-23.16c-.117-1.008-.043-2.078.254-3.43-.484 1.414-1.246 1.656-2.465.797 1.032.922 1.715 1.746 2.211 2.633Z" stroke="#000" fill="none" stroke-width="0.398" stroke-miterlimit="10" stroke-linejoin="bevel"></path></svg><figcaption><b>Fig <!-- -->3<!-- -->.</b> <!-- -->Demonstration of potential issues in inserting nodes at the root when lacking a black parent.</figcaption></figure><p>As we can see here, our previous reasoning does not catch this red-children violation because it does not conform to our previous cases, by virtue of the inserted node not having a grandfather. This case can <em>only</em> happen at the root, however, since that is the only location where that can occur. As a result, the simple solution is to simply make the root of any red-black tree black - it will preserve the black height invariant, but also result in this red-red violation being impossible. We can amend our code as follows:</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert&#x27;</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> insert&#x27; </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">insert&#x27; L </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert&#x27; R </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> insert&#x27; T </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Leaf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, this results in our completed code for the <code>insert</code> function. Note that because of the signature that we are ascribing to, helper functions such as <code>balance</code> and <code>insert</code> will not be visible to the client of the module, so there is no harm in declaring them within the namespace of the functor.</p><p>Our completed code for a red-black tree implementation of dictionaries is thus as follows. Note that the implementation of <code>lookup</code> is very straightforward, and</p><div class="language-sml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">functor</span><span class="token plain"> </span><span class="token class-name">RedBlackDict</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Key </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ORDERED</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> DICT </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">key</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">datatype</span><span class="token plain"> </span><span class="token class-name">color</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Red </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Black</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">datatype</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">color </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">&#x27;a</span><span class="token plain"> dict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Leaf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance T </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> T</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert&#x27;</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Red</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Leaf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> insert&#x27; </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">insert&#x27; L </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> insert&#x27; R </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">insert</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> insert&#x27; T </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Leaf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Black</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lookup</span><span class="token plain"> Leaf k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NONE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> lookup </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Node </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">L</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> Key</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LESS </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> lookup L k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EQUAL </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> SOME v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GREATER </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> lookup R k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the end, usage of modules allows us to write a powerful, parameterized implementation of a dictionary interface, in such a way that we ensure that our <em>representation invariants</em> are respected throughout each operation. By making a structure ascribing to the <code>ORDERED</code> typeclass a parameter of the functor <code>RedBlackDict</code>, we allow powerful generality in the type of the key to the dictionary, without having to introduce additional overhead in the functions of the module itself.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a class="hash-link" href="#conclusions" title="Direct link to heading">​</a></h2><p>In this chapter, we have seen how functors are a potent tool when structuring our code, that allows us to enforce modularity and implement code reuse <em>within the language itself</em>. Functors also form the basis for a kind of <em>higher-order module</em>, where we can parameterize the structures we are capable of creating by other structures themselves, resulting in a greater degree of expression and versatility not unlike those of higher-order functions themselves.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/book/docs/concepts/modules/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Modules</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/book/docs/concepts/sequences/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Sequences</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#functors-the-basics" class="table-of-contents__link toc-highlight">Functors: The Basics</a></li><li><a href="#functors-syntactic-sugar" class="table-of-contents__link toc-highlight">Functors: Syntactic Sugar</a></li><li><a href="#case-study-typeclasses" class="table-of-contents__link toc-highlight">Case study: Typeclasses</a></li><li><a href="#case-study-red-black-trees" class="table-of-contents__link toc-highlight">Case study: Red-black trees</a></li><li><a href="#conclusions" class="table-of-contents__link toc-highlight">Conclusions</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/book/assets/js/runtime~main.3cbcc436.js"></script>
<script src="/book/assets/js/main.357cef8a.js"></script>
</body>
</html>